<!doctype lake><title>如何用 RAG (检索增强生成) 打造知识库 QA 系统</title><meta name="doc-version" content="1" /><meta name="viewport" content="fixed" /><meta name="typography" content="classic" /><meta name="paragraphSpacing" content="relax" /><blockquote data-lake-id="u50a601e7" id="u50a601e7"><p data-lake-id="u609860b6" id="u609860b6"><span data-lake-id="u5ceb9f6e" id="u5ceb9f6e">原项目地址<br /></span><a href="https://github.com/rag-web-ui/rag-web-ui/blob/main/docs/tutorial/README.md" target="_blank" data-lake-id="u224c0a02" id="u224c0a02"><span data-lake-id="u007b0247" id="u007b0247">https://github.com/rag-web-ui/rag-web-ui/blob/main/docs/tutorial/README.md</span></a></p></blockquote><h2 data-lake-id="VD6AX" id="VD6AX"><span data-lake-id="u3c9a13a6" id="u3c9a13a6">项目简介</span></h2><p data-lake-id="u86f7be84" id="u86f7be84"><span data-lake-id="u980ef9c2" id="u980ef9c2">在人工智能快速发展的今天，RAG（检索增强生成）技术正在改变我们构建知识库系统的方式。本项目旨在为大家提供一个完整的、可实操的 RAG 知识库系统实践指南。</span></p><h3 data-lake-id="Zz1yy" id="Zz1yy"><span data-lake-id="u334689d6" id="u334689d6">项目特点</span></h3><ul list="u66572fa3"><li fid="u1d6898f9" data-lake-id="u7bf9b391" id="u7bf9b391"><span data-lake-id="ue7fd4f14" id="ue7fd4f14">🚀</span><span data-lake-id="ufbc1cbb8" id="ufbc1cbb8"> </span><strong><span data-lake-id="u9c0f232f" id="u9c0f232f">零门槛入门</span></strong><span data-lake-id="u5501eb32" id="u5501eb32">：不需要复杂的基础设施，使用常见开发工具即可上手</span></li></ul><ul list="uc43ec40e" start="2"><li fid="u231927b9" data-lake-id="u7e4e4367" id="u7e4e4367"><span data-lake-id="ud4c28f3d" id="ud4c28f3d">💡</span><span data-lake-id="u11dcc643" id="u11dcc643"> </span><strong><span data-lake-id="u9e2447d5" id="u9e2447d5">实用性强</span></strong><span data-lake-id="uff60f7ab" id="uff60f7ab">：基于实际项目经验，提供完整的端到端解决方案</span></li></ul><ul list="u5d9bc4c3" start="3"><li fid="u144f8c72" data-lake-id="uc8108b9c" id="uc8108b9c"><span data-lake-id="ub8d948f8" id="ub8d948f8">🔧</span><span data-lake-id="ufea46ee0" id="ufea46ee0"> </span><strong><span data-lake-id="u98792a98" id="u98792a98">可扩展性</span></strong><span data-lake-id="u9a8876f5" id="u9a8876f5">：采用模块化设计，方便后续功能扩展</span></li></ul><ul list="uc6cb6f28" start="4"><li fid="u33720f57" data-lake-id="u4768d467" id="u4768d467"><span data-lake-id="ueb945952" id="ueb945952">📚</span><span data-lake-id="u61d86f53" id="u61d86f53"> </span><strong><span data-lake-id="u963f7109" id="u963f7109">全流程演示</span></strong><span data-lake-id="u61e889ba" id="u61e889ba">：从文档处理到系统部署，每个环节都有详细说明</span></li></ul><h3 data-lake-id="LUGza" id="LUGza"><span data-lake-id="u4357d757" id="u4357d757">技术架构</span></h3><p data-lake-id="ucbc77f54" id="ucbc77f54"><span data-lake-id="u5fded6be" id="u5fded6be">项目流程图：</span></p><card type="block" name="diagram" value="data:%7B%22type%22%3A%22mermaid%22%2C%22code%22%3A%22graph%20TB%5Cn%20%20%20%20%25%25%20%E8%A7%92%E8%89%B2%E5%AE%9A%E4%B9%89%5Cn%20%20%20%20client%5B%5C%22%E8%B0%83%E7%94%A8%E6%96%B9%2F%E7%94%A8%E6%88%B7%5C%22%5D%5Cn%20%20%20%20open_api%5B%5C%22%E5%BC%80%E6%94%BE%20API%5C%22%5D%5Cn%20%20%20%20%5Cn%20%20%20%20subgraph%20import_process%5B%5C%22%E6%96%87%E6%A1%A3%E5%AF%BC%E5%85%A5%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%5C%22%5D%5Cn%20%20%20%20%20%20%20%20direction%20TB%5Cn%20%20%20%20%20%20%20%20%25%25%20%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E5%92%8C%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%5Cn%20%20%20%20%20%20%20%20docs%5B%5C%22%E6%96%87%E6%A1%A3%E8%BE%93%E5%85%A5%3Cbr%2F%3E(PDF%2FMD%2FTXT%2FDOCX)%5C%22%5D%5Cn%20%20%20%20%20%20%20%20job_id%5B%5C%22%E8%BF%94%E5%9B%9E%E4%BB%BB%E5%8A%A1ID%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20nfs%5B%5C%22%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%5C%22%5D%5Cn%5Cn%20%20%20%20%20%20%20%20subgraph%20async_process%5B%5C%22%E5%BC%82%E6%AD%A5%E6%96%87%E6%A1%A3%E5%A4%84%E7%90%86%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20direction%20TB%5Cn%20%20%20%20%20%20%20%20%20%20%20%20preprocess%5B%5C%22%E6%96%87%E6%A1%A3%E9%A2%84%E5%A4%84%E7%90%86%3Cbr%2F%3E(%E6%96%87%E6%9C%AC%E6%8F%90%E5%8F%96%2F%E6%B8%85%E6%B4%97)%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20split%5B%5C%22%E6%96%87%E6%9C%AC%E5%88%86%E5%89%B2%3Cbr%2F%3E(%E5%88%86%E6%AE%B5%2F%E9%87%8D%E5%8F%A0)%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20%20%20subgraph%20embedding_process%5B%5C%22%E5%90%91%E9%87%8F%E5%8C%96%E6%9C%8D%E5%8A%A1%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20direction%20LR%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20embedding_api%5B%5C%22%E5%90%91%E9%87%8F%E5%8C%96%20API%5C%22%5D%20--%3E%20embedding_server%5B%5C%22%E5%90%91%E9%87%8F%E5%8C%96%E6%9C%8D%E5%8A%A1%E5%99%A8%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20end%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20%20%20store%5B(%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93)%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%25%25%20%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86%E5%86%85%E9%83%A8%E6%B5%81%E7%A8%8B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20preprocess%20--%3E%20split%5Cn%20%20%20%20%20%20%20%20%20%20%20%20split%20--%3E%20embedding_api%5Cn%20%20%20%20%20%20%20%20%20%20%20%20embedding_server%20--%3E%20store%5Cn%20%20%20%20%20%20%20%20end%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20subgraph%20job_query%5B%5C%22%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%5C%22%5D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20direction%20TB%5Cn%20%20%20%20%20%20%20%20%20%20%20%20job_status%5B%5C%22%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81%3Cbr%2F%3E(%E5%A4%84%E7%90%86%E4%B8%AD%2F%E5%B7%B2%E5%AE%8C%E6%88%90%2F%E5%A4%B1%E8%B4%A5)%5C%22%5D%5Cn%20%20%20%20%20%20%20%20end%5Cn%20%20%20%20end%5Cn%20%20%20%20%5Cn%20%20%20%20%25%25%20%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1%E6%B5%81%E7%A8%8B%20%20%5Cn%20%20%20%20subgraph%20query_process%5B%5C%22%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1%5C%22%5D%5Cn%20%20%20%20%20%20%20%20direction%20LR%5Cn%20%20%20%20%20%20%20%20user_history%5B%5C%22%E7%94%A8%E6%88%B7%E5%8E%86%E5%8F%B2%5C%22%5D%20--%3E%20query%5B%5C%22%E7%94%A8%E6%88%B7%E6%9F%A5%E8%AF%A2%3Cbr%2F%3E(%E5%9F%BA%E4%BA%8E%E7%94%A8%E6%88%B7%E5%8E%86%E5%8F%B2)%5C%22%5D%5Cn%20%20%20%20%20%20%20%20query%20--%3E%20query_embed%5B%5C%22%E6%9F%A5%E8%AF%A2%E5%90%91%E9%87%8F%E5%8C%96%5C%22%5D%5Cn%20%20%20%20%20%20%20%20query_embed%20--%3E%20retrieve%5B%5C%22%E5%90%91%E9%87%8F%E6%A3%80%E7%B4%A2%5C%22%5D%5Cn%20%20%20%20%20%20%20%20retrieve%20--%3E%20rerank%5B%5C%22%E9%87%8D%E6%8E%92%E5%BA%8F%3Cbr%2F%3E(%E4%BA%A4%E5%8F%89%E7%BC%96%E7%A0%81%E5%99%A8)%5C%22%5D%5Cn%20%20%20%20%20%20%20%20rerank%20--%3E%20context%5B%5C%22%E4%B8%8A%E4%B8%8B%E6%96%87%E7%BB%84%E8%A3%85%5C%22%5D%5Cn%20%20%20%20%20%20%20%20context%20--%3E%20llm%5B%5C%22%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E7%94%9F%E6%88%90%5C%22%5D%5Cn%20%20%20%20%20%20%20%20llm%20--%3E%20response%5B%5C%22%E6%9C%80%E7%BB%88%E5%93%8D%E5%BA%94%5C%22%5D%5Cn%20%20%20%20%20%20%20%20query%20-.-%3E%20rerank%5Cn%20%20%20%20end%5Cn%20%20%20%20%5Cn%20%20%20%20%25%25%20%E4%B8%BB%E8%A6%81%E6%B5%81%E7%A8%8B%E8%BF%9E%E6%8E%A5%5Cn%20%20%20%20client%20--%3E%20%7C%5C%221.%E4%B8%8A%E4%BC%A0%E6%96%87%E6%A1%A3%5C%22%7C%20docs%5Cn%20%20%20%20docs%20--%3E%20%7C%5C%222.%E7%94%9F%E6%88%90%5C%22%7C%20job_id%5Cn%20%20%20%20docs%20--%3E%20%7C%5C%223a.%E8%A7%A6%E5%8F%91%5C%22%7C%20async_process%5Cn%20%20%20%20job_id%20--%3E%20%7C%5C%223b.%E8%BF%94%E5%9B%9E%5C%22%7C%20client%5Cn%20%20%20%20docs%20--%3E%20nfs%5Cn%20%20%20%20nfs%20--%3E%20preprocess%5Cn%5Cn%20%20%20%20%25%25%20%E5%BC%80%E6%94%BE%20API%20%E6%A3%80%E7%B4%A2%E6%B5%81%E7%A8%8B%5Cn%20%20%20%20open_api%20--%3E%20%7C%5C%22%E6%A3%80%E7%B4%A2%E4%B8%8A%E4%B8%8B%E6%96%87%5C%22%7C%20retrieval_service%5B%5C%22%E6%A3%80%E7%B4%A2%E6%9C%8D%E5%8A%A1%5C%22%5D%5Cn%20%20%20%20retrieval_service%20--%3E%20%7C%5C%22%E8%AE%BF%E9%97%AE%5C%22%7C%20store%5Cn%20%20%20%20retrieval_service%20--%3E%20%7C%5C%22%E8%BF%94%E5%9B%9E%E4%B8%8A%E4%B8%8B%E6%96%87%5C%22%7C%20open_api%5Cn%5Cn%20%20%20%20%25%25%20%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B%5Cn%20%20%20%20client%20--%3E%20%7C%5C%224.%E8%BD%AE%E8%AF%A2%5C%22%7C%20job_status%5Cn%20%20%20%20job_status%20--%3E%20%7C%5C%225.%E8%BF%94%E5%9B%9E%E8%BF%9B%E5%BA%A6%5C%22%7C%20client%5Cn%20%20%20%20%5Cn%20%20%20%20%25%25%20%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E5%88%B0%E6%9F%A5%E8%AF%A2%E6%9C%8D%E5%8A%A1%5Cn%20%20%20%20store%20--%3E%20retrieve%5Cn%5Cn%20%20%20%20%25%25%20%E6%A0%B7%E5%BC%8F%E5%AE%9A%E4%B9%89%EF%BC%88%E8%B0%83%E6%95%B4%E4%BB%A5%E5%8C%B9%E9%85%8D%20GitHub%20%E4%B8%BB%E9%A2%98%E9%A2%9C%E8%89%B2%EF%BC%89%5Cn%20%20%20%20classDef%20process%20fill%3A%23d1ecf1%2Cstroke%3A%230077b6%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20database%20fill%3A%23e2eafc%2Cstroke%3A%23003566%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20input%20fill%3A%23caf0f8%2Cstroke%3A%230077b6%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20output%20fill%3A%23ffc8dd%2Cstroke%3A%23d00000%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20rerank%20fill%3A%23cdb4db%2Cstroke%3A%235a189a%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20async%20fill%3A%23f8edeb%2Cstroke%3A%237f5539%2Cstroke-width%3A1px%2Cstroke-dasharray%3A%205%205%5Cn%20%20%20%20classDef%20actor%20fill%3A%23fefae0%2Cstroke%3A%23606c38%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20jobQuery%20fill%3A%23ffedd8%2Cstroke%3A%23ca6702%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20queryProcess%20fill%3A%23d8f3dc%2Cstroke%3A%2340916c%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20embeddingService%20fill%3A%23ffe5d9%2Cstroke%3A%239d0208%2Cstroke-width%3A1px%5Cn%20%20%20%20classDef%20importProcess%20fill%3A%23e5e5e5%2Cstroke%3A%23495057%2Cstroke-width%3A1px%5Cn%5Cn%20%20%20%20%25%25%20%E5%BA%94%E7%94%A8%E6%A0%B7%E5%BC%8F%E5%88%B0%E8%8A%82%E7%82%B9%5Cn%20%20%20%20class%20docs%2Cquery%2Cretrieval_service%20input%5Cn%20%20%20%20class%20preprocess%2Csplit%2Cquery_embed%2Cretrieve%2Ccontext%2Cllm%20process%5Cn%20%20%20%20class%20store%2Cnfs%20database%5Cn%20%20%20%20class%20response%2Cjob_id%2Cjob_status%20output%5Cn%20%20%20%20class%20rerank%20rerank%5Cn%20%20%20%20class%20async_process%20async%5Cn%20%20%20%20class%20client%2Copen_api%20actor%5Cn%20%20%20%20class%20job_query%20jobQuery%5Cn%20%20%20%20style%20query_process%20fill%3A%23d8f3dc%2Cstroke%3A%2340916c%2Cstroke-width%3A1px%5Cn%20%20%20%20style%20embedding_process%20fill%3A%23ffe5d9%2Cstroke%3A%239d0208%2Cstroke-width%3A1px%5Cn%20%20%20%20style%20import_process%20fill%3A%23e5e5e5%2Cstroke%3A%23495057%2Cstroke-width%3A1px%5Cn%20%20%20%20style%20job_query%20fill%3A%23ffedd8%2Cstroke%3A%23ca6702%2Cstroke-width%3A1px%22%2C%22url%22%3Anull%2C%22id%22%3A%22tLFdw%22%7D"></card><h2 data-lake-id="yBskf" id="yBskf"><span data-lake-id="u9998c277" id="u9998c277">1. 认识 RAG：为什么要&quot;检索 + 生成&quot;</span></h2><h3 data-lake-id="xImHc" id="xImHc"><span data-lake-id="u55ef7460" id="u55ef7460">1.1 什么是 RAG</span></h3><p data-lake-id="u2437dc2b" id="u2437dc2b"><span data-lake-id="u1ccd797d" id="u1ccd797d">RAG 是 Retrieval-Augmented Generation 的缩写，中文翻译为&quot;检索增强生成&quot;。它是一种将检索系统和生成式 AI 模型结合的技术方案，主要包含两个核心步骤：</span></p><ol list="u3ab5eee8"><li fid="u3c9e6a4d" data-lake-id="u6483585f" id="u6483585f"><span data-lake-id="u95ebb565" id="u95ebb565">检索（Retrieval）：根据用户输入的问题，从知识库中检索出相关的文档或信息片段</span></li></ol><ol list="ub2640796" start="2"><li fid="u1950e2fd" data-lake-id="ue01e23ef" id="ue01e23ef"><span data-lake-id="u1929aabe" id="u1929aabe">生成（Generation）：将检索到的相关信息作为上下文，结合用户问题，让大语言模型生成准确的回答</span></li></ol><p data-lake-id="u4695c308" id="u4695c308"><span data-lake-id="u9b694ae4" id="u9b694ae4">这种方案既能让模型基于最新的知识作答，又可以提供可溯源的参考依据，有效解决了大语言模型的知识时效性和事实准确性问题。</span></p><p data-lake-id="u2a22544d" id="u2a22544d"><span data-lake-id="u72c8b02b" id="u72c8b02b">下面这张图展示了 RAG 在对话过程中的工作流程:</span></p><card type="block" name="diagram" value="data:%7B%22type%22%3A%22mermaid%22%2C%22code%22%3A%22flowchart%20TD%5Cn%20%20%20%20User%5B%5C%22%E7%94%A8%E6%88%B7%3A%20%E9%97%AE%E9%A2%98%5C%22%5D%20--%3E%20Retrieval%5B%5C%22%E6%A3%80%E7%B4%A2%E6%A8%A1%E5%9D%97%5C%22%5D%5Cn%20%20%20%20KB%5B%5C%22%E7%9F%A5%E8%AF%86%E5%BA%93%5C%22%5D%20--%3E%20Doc1%5B%5C%22%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A31%5C%22%5D%5Cn%20%20%20%20KB%20--%3E%20Doc2%5B%5C%22%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A32%5C%22%5D%5Cn%20%20%20%20Retrieval%20--%3E%20Doc1%5Cn%20%20%20%20Retrieval%20--%3E%20Doc2%5Cn%20%20%20%20Doc1%20--%3E%20LLM%5B%5C%22%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%5C%22%5D%5Cn%20%20%20%20Doc2%20--%3E%20LLM%5Cn%20%20%20%20LLM%20--%3E%20Answer%5B%5C%22%E5%8A%A9%E6%89%8B%3A%20%E7%94%9F%E6%88%90%E7%9A%84%E5%9B%9E%E7%AD%94%5C%22%5D%5Cn%5Cn%20%20%20%20style%20User%20fill%3A%23f9f%2Cstroke%3A%23333%5Cn%20%20%20%20style%20KB%20fill%3A%23bbf%2Cstroke%3A%23333%5Cn%20%20%20%20style%20LLM%20fill%3A%23bfb%2Cstroke%3A%23333%5Cn%20%20%20%20style%20Answer%20fill%3A%23fbb%2Cstroke%3A%23333%22%2C%22url%22%3Anull%2C%22id%22%3A%22zasb4%22%7D"></card><h3 data-lake-id="aZCGI" id="aZCGI"><span data-lake-id="ufe0381f4" id="ufe0381f4">1.2 为什么需要 RAG</span></h3><p data-lake-id="uea3a331a" id="uea3a331a"><span data-lake-id="u1838366f" id="u1838366f">让我们对比三种问答方案的优缺点，来理解为什么 RAG 是一个更好的选择：</span></p><ol list="uc6a633c0"><li fid="u1ab50224" data-lake-id="u23effa97" id="u23effa97"><span data-lake-id="u4f08ebf3" id="u4f08ebf3">传统检索式问答 (Retrieval QA)</span></li></ol><ul list="ua4670b6d" data-lake-indent="1"><li fid="ued54f022" data-lake-id="u873e33f6" id="u873e33f6"><span data-lake-id="ua5dcf3f7" id="ua5dcf3f7">✅</span><span data-lake-id="u5165f6c0" id="u5165f6c0"> 可靠性高：答案直接来自知识库，有明确的来源</span></li></ul><ul list="u78d27a9f" start="2" data-lake-indent="1"><li fid="ufabf94f8" data-lake-id="u09ffc515" id="u09ffc515"><span data-lake-id="u600822f6" id="u600822f6">✅</span><span data-lake-id="ud8e2dc76" id="ud8e2dc76"> 知识可更新：添加新文档即可更新知识</span></li></ul><ul list="u8bdeb735" start="3" data-lake-indent="1"><li fid="u12354c28" data-lake-id="u0f6d94d5" id="u0f6d94d5"><span data-lake-id="u1d3e5d75" id="u1d3e5d75">❌</span><span data-lake-id="u61b9d108" id="u61b9d108"> 灵活性差：只能返回知识库中已有的内容</span></li></ul><ul list="u057fc0f0" start="4" data-lake-indent="1"><li fid="ued3ffea3" data-lake-id="u92fbd8c4" id="u92fbd8c4"><span data-lake-id="u7c9f0abf" id="u7c9f0abf">❌</span><span data-lake-id="uede2a46a" id="uede2a46a"> 表达生硬：难以用自然语言组织答案</span></li></ul><ol list="u81033a91" start="2"><li fid="u7fba34c6" data-lake-id="u75098451" id="u75098451"><span data-lake-id="ud79ea9c8" id="ud79ea9c8">纯 LLM 问答</span></li></ol><ul list="u113ca1cd" data-lake-indent="1"><li fid="u9ea122c0" data-lake-id="u82e5a1c3" id="u82e5a1c3"><span data-lake-id="u1298dd0d" id="u1298dd0d">✅</span><span data-lake-id="ue7dd32db" id="ue7dd32db"> 表达自然：能用流畅的语言组织答案</span></li></ul><ul list="u56251c0d" start="2" data-lake-indent="1"><li fid="u747fc643" data-lake-id="u39e7edec" id="u39e7edec"><span data-lake-id="u08f7f3f5" id="u08f7f3f5">✅</span><span data-lake-id="u3fc9284b" id="u3fc9284b"> 灵活理解：可以理解各种表达方式的问题</span></li></ul><ul list="ua3b244a4" start="3" data-lake-indent="1"><li fid="u516d2918" data-lake-id="u63e2972d" id="u63e2972d"><span data-lake-id="uf924860a" id="uf924860a">❌</span><span data-lake-id="ue09184a6" id="ue09184a6"> 知识固化：知识仅限于训练数据，无法及时更新</span></li></ul><ul list="uc5695e56" start="4" data-lake-indent="1"><li fid="uf085b120" data-lake-id="u96a6ecda" id="u96a6ecda"><span data-lake-id="u0dcd7205" id="u0dcd7205">❌</span><span data-lake-id="uf071967e" id="uf071967e"> 可靠性差：容易产生幻觉，难以验证答案准确性</span></li></ul><ol list="u07deb363" start="3"><li fid="u6b8d0aae" data-lake-id="uf379a56f" id="uf379a56f"><span data-lake-id="ub5491f77" id="ub5491f77">RAG 方案</span></li></ol><ul list="uba10c6ae" data-lake-indent="1"><li fid="u1d62cb9e" data-lake-id="u4d33f0e0" id="u4d33f0e0"><span data-lake-id="u94657b4f" id="u94657b4f">✅</span><span data-lake-id="u1508c64c" id="u1508c64c"> 可靠且可溯源：答案基于检索到的具体文档</span></li></ul><ul list="ua3ce0266" start="2" data-lake-indent="1"><li fid="u167ee559" data-lake-id="u74a76431" id="u74a76431"><span data-lake-id="ub9809875" id="ub9809875">✅</span><span data-lake-id="ue5506cd7" id="ue5506cd7"> 知识可更新：可以持续添加新的知识</span></li></ul><ul list="uf9d6f53b" start="3" data-lake-indent="1"><li fid="ubcb1439e" data-lake-id="u4d0747fc" id="u4d0747fc"><span data-lake-id="u5635c59b" id="u5635c59b">✅</span><span data-lake-id="u9c49844c" id="u9c49844c"> 表达自然：利用 LLM 的语言能力组织答案</span></li></ul><ul list="u14a54c8c" start="4" data-lake-indent="1"><li fid="u05e49ce5" data-lake-id="uf6748c33" id="uf6748c33"><span data-lake-id="u11bd4664" id="u11bd4664">✅</span><span data-lake-id="ub52d8453" id="ub52d8453"> 灵活理解：能理解各种形式的问题</span></li></ul><ul list="u92924cd9" start="5" data-lake-indent="1"><li fid="uaad0821a" data-lake-id="u55621be9" id="u55621be9"><span data-lake-id="uad6adbf5" id="uad6adbf5">✅</span><span data-lake-id="ue10a88e1" id="ue10a88e1"> 成本可控：主要消耗在必要的 API 调用上</span></li></ul><p data-lake-id="u506e1192" id="u506e1192"><span data-lake-id="ubb6c6956" id="ubb6c6956">RAG 通过将检索和生成相结合，既保留了传统检索问答的可靠性，又获得了 LLM 的灵活性和自然表达能力。它能让 AI 始终基于最新的、可信的知识来回答问题，同时保持对话的流畅自然。</span></p><p data-lake-id="u3cab34e8" id="u3cab34e8"><span data-lake-id="uf8cf47e1" id="uf8cf47e1">RAG 的典型应用场景</span></p><ul list="u494bbd61"><li fid="ub91eae2f" data-lake-id="udf5d757e" id="udf5d757e"><span data-lake-id="u5ddc8784" id="u5ddc8784">企业知识库问答：帮助企业构建对内员工知识库或对外客户问答系统。</span></li></ul><ul list="u18161119" start="2"><li fid="u74276b4d" data-lake-id="u5e19ad7b" id="u5e19ad7b"><span data-lake-id="u0e85196c" id="u0e85196c">法律法规、论文等参考场景：需要给出权威来源或证据的回答。</span></li></ul><ul list="ubd4682c6" start="3"><li fid="u47ba1b54" data-lake-id="udfa782df" id="udfa782df"><span data-lake-id="uebadc77b" id="uebadc77b">任何需要&quot;带有引用信息&quot;的回答场景。</span></li></ul><h2 data-lake-id="ssMmR" id="ssMmR"><span data-lake-id="ubd598410" id="ubd598410">2. RAG 系统整体架构与数据流</span></h2><h3 data-lake-id="dNPGV" id="dNPGV"><span data-lake-id="u830bc1fb" id="u830bc1fb">2.1 核心组件</span></h3><ul list="udb618da8"><li fid="uf403b5c4" data-lake-id="u0a794daa" id="u0a794daa"><span data-lake-id="u9e9ab3b6" id="u9e9ab3b6">向量数据库：用来存储文档分块后的向量（如 ChromaDB、Qdrant）。</span></li></ul><ul list="u0ac78a28" start="2"><li fid="u7b5964ea" data-lake-id="ufd648201" id="ufd648201"><span data-lake-id="u277dc25d" id="u277dc25d">Embedding（文本向量化）：将文本转化为可比较的数值向量，形如 [0.1, 0.2, 0.3, 0.4, 0.5]</span></li></ul><ul list="uc82509f2" start="3"><li fid="uf55ce684" data-lake-id="u5a6625f3" id="u5a6625f3"><span data-lake-id="uc4e930fc" id="uc4e930fc">检索 (Retrieval)：根据用户查询的向量相似度，检索出最相关的文档切片。</span></li></ul><ul list="ub1593546" start="4"><li fid="udc131e9b" data-lake-id="u0f074ee4" id="u0f074ee4"><span data-lake-id="uc8a19315" id="uc8a19315">大语言模型：将检索到的上下文与用户问题组合，再由模型 (LLM) 生成最终答案。</span></li></ul><ul list="u96f2ed53" start="5"><li fid="ue0cff8e1" data-lake-id="u97f41782" id="u97f41782"><span data-lake-id="ued8b4890" id="ued8b4890">生成 (Generation) 与引用：如何在回答中嵌入引用链接或标注，方便用户溯源。</span></li></ul><h3 data-lake-id="DKc4f" id="DKc4f"><span data-lake-id="ua8b9847d" id="ua8b9847d">2.2 RAG 的典型工作流</span></h3><ol list="u0ac4eeeb"><li fid="u2686642b" data-lake-id="ud4c4cea3" id="ud4c4cea3"><span data-lake-id="u125ccac9" id="u125ccac9">用户输入问题。</span></li></ol><ol list="uec5c74ee" start="2"><li fid="u915e9f16" data-lake-id="u1711df32" id="u1711df32"><span data-lake-id="u78f8d557" id="u78f8d557">将问题向量化，然后检索最相似的文档切片。</span></li></ol><ol list="uf3f484b8" start="3"><li fid="uf0c898a7" data-lake-id="u84350fc0" id="u84350fc0"><span data-lake-id="u3da48187" id="u3da48187">将检索到的上下文与问题拼接后输入 LLM。</span></li></ol><ol list="u2ad69ca9" start="4"><li fid="u9dd28ce9" data-lake-id="u4c80bc09" id="u4c80bc09"><span data-lake-id="uad8b3aae" id="uad8b3aae">LLM 输出带引用信息的回答。</span></li></ol><ol list="u88aae022" start="5"><li fid="u69649be0" data-lake-id="u9fbc4223" id="u9fbc4223"><span data-lake-id="udc72b2bb" id="udc72b2bb">前端渲染回答、可选地在可视化界面中展示引用详情。</span></li></ol><p data-lake-id="u162ad747" id="u162ad747"><span data-lake-id="u845840d6" id="u845840d6">下面用一张图展示各个组件的交互流程：</span></p><card type="block" name="diagram" value="data:%7B%22type%22%3A%22mermaid%22%2C%22code%22%3A%22flowchart%20TD%5Cn%20%20%20%20User%5B%5C%22%E7%94%A8%E6%88%B7%E9%97%AE%E9%A2%98%5C%22%5D%20--%3E%20Embedding%5B%5C%22%E6%96%87%E6%9C%AC%E5%90%91%E9%87%8F%E5%8C%96%5C%5Cn(Embedding)%5C%22%5D%5Cn%20%20%20%20DB%5B(%E7%9F%A5%E8%AF%86%E5%BA%93%5C%5Cn%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93)%5D%20--%3E%20Retrieval%5Cn%20%20%20%20Embedding%20--%3E%20Retrieval%5B%5C%22%E6%A3%80%E7%B4%A2%E6%A8%A1%E5%9D%97%5C%5Cn(%E7%9B%B8%E4%BC%BC%E5%BA%A6%E5%8C%B9%E9%85%8D)%5C%22%5D%5Cn%20%20%20%20Retrieval%20--%3E%20Context%5B%5C%22%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3%E7%89%87%E6%AE%B5%5C%22%5D%5Cn%20%20%20%20Context%20--%3E%20Assembly%5B%5C%22%E4%B8%8A%E4%B8%8B%E6%96%87%E7%BB%84%E8%A3%85%5C%22%5D%5Cn%20%20%20%20Assembly%20--%3E%20LLM%5B%5C%22%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%5C%22%5D%5Cn%20%20%20%20LLM%20--%3E%20Answer%5B%5C%22%E5%B8%A6%E5%BC%95%E7%94%A8%E7%9A%84%E5%9B%9E%E7%AD%94%5C%22%5D%5Cn%20%20%20%20Answer%20--%3E%20Frontend%5B%5C%22%E5%89%8D%E7%AB%AF%E5%B1%95%E7%A4%BA%5C%5Cn-%20%E5%9B%9E%E7%AD%94%E5%86%85%E5%AE%B9%5C%5Cn-%20%E5%BC%95%E7%94%A8%E6%9D%A5%E6%BA%90%5C%5Cn-%20%E7%9B%B8%E5%85%B3%E5%BA%A6%5C%22%5D%5Cn%5Cn%20%20%20%20style%20User%20fill%3A%23f9f%2Cstroke%3A%23333%5Cn%20%20%20%20style%20DB%20fill%3A%23bbf%2Cstroke%3A%23333%5Cn%20%20%20%20style%20LLM%20fill%3A%23bfb%2Cstroke%3A%23333%5Cn%20%20%20%20style%20Frontend%20fill%3A%23fbb%2Cstroke%3A%23333%22%2C%22url%22%3Anull%2C%22id%22%3A%22YfvjC%22%7D"></card><h2 data-lake-id="m40tX" id="m40tX"><span data-lake-id="u509f18e5" id="u509f18e5">3. 构建知识库：文档处理、嵌入、存储</span></h2><h3 data-lake-id="BVzmm" id="BVzmm"><span data-lake-id="ue0b53633" id="ue0b53633">3.1 文档上传与分块 (Chunking)</span></h3><h4 data-lake-id="NLH8B" id="NLH8B"><span data-lake-id="uc6e0d2d7" id="uc6e0d2d7">3.1.1 为什么要对文档进行分块？</span></h4><p data-lake-id="u21437c1a" id="u21437c1a"><span data-lake-id="u613f5a0d" id="u613f5a0d">文档分块是 RAG 系统中的一个关键步骤，主要有以下几个原因：</span></p><ol list="u5e34dce2"><li fid="ud8db332a" data-lake-id="u8d78382f" id="u8d78382f"><span data-lake-id="ud3ad7f20" id="ud3ad7f20">向量相似度计算的精度</span></li></ol><ul list="u9eec679b" data-lake-indent="1"><li fid="u331c1bfc" data-lake-id="u8418788d" id="u8418788d"><span data-lake-id="u7d4135f3" id="u7d4135f3">过长的文本会导致向量表示不够精确</span></li></ul><ul list="ub57365dc" start="2" data-lake-indent="1"><li fid="u9ecc7096" data-lake-id="u0c552140" id="u0c552140"><span data-lake-id="u40ebbc05" id="u40ebbc05">较小的文本块能更好地捕捉局部语义</span></li></ul><ul list="uaeaf4984" start="3" data-lake-indent="1"><li fid="u58d0dcd9" data-lake-id="u99dd96e9" id="u99dd96e9"><span data-lake-id="u153ce3a4" id="u153ce3a4">有助于提高检索的准确性</span></li></ul><ol list="u72947e85" start="2"><li fid="ub2e21ef3" data-lake-id="ue50f54dd" id="ue50f54dd"><span data-lake-id="ue252000a" id="ue252000a">LLM 的上下文窗口限制</span></li></ol><ul list="u72e6e0f4" data-lake-indent="1"><li fid="ud3ec194b" data-lake-id="u81675e98" id="u81675e98"><span data-lake-id="ub8f12c53" id="ub8f12c53">LLM 的输入长度是有限的 （虽然 Qwen 已经推出了 1M token 的上下文窗口 0.0）</span></li></ul><ul list="udc2c36ad" start="2" data-lake-indent="1"><li fid="ube477ecf" data-lake-id="u00575436" id="u00575436"><span data-lake-id="u1bb37ff7" id="u1bb37ff7">需要将文档切分为适合 LLM 处理的大小</span></li></ul><ul list="u6824e48f" start="3" data-lake-indent="1"><li fid="u689f64ca" data-lake-id="u7659e5b5" id="u7659e5b5"><span data-lake-id="ue96a5056" id="ue96a5056">避免超出 token 限制导致信息丢失</span></li></ul><ol list="u869b252e" start="3"><li fid="udf562df0" data-lake-id="uccafc897" id="uccafc897"><span data-lake-id="ubb2b15b8" id="ubb2b15b8">检索效率与成本</span></li></ol><ul list="u8cb9d2c8" data-lake-indent="1"><li fid="u03afd922" data-lake-id="u045c8db7" id="u045c8db7"><span data-lake-id="u5b071acb" id="u5b071acb">更小的文本块便于建立细粒度的索引</span></li></ul><ul list="u3cacb524" start="2" data-lake-indent="1"><li fid="u932dbf4a" data-lake-id="u3e680aad" id="u3e680aad"><span data-lake-id="u44ca3e3c" id="u44ca3e3c">只需检索最相关的片段，节省 token 用量</span></li></ul><ul list="u68014147" start="3" data-lake-indent="1"><li fid="u352ca485" data-lake-id="u182bbfe9" id="u182bbfe9"><span data-lake-id="u254712a6" id="u254712a6">减少无关信息，提高回答质量</span></li></ul><ol list="u0ea4d6ee" start="4"><li fid="u5ee83c8a" data-lake-id="u8130d27f" id="u8130d27f"><span data-lake-id="ua372d838" id="ua372d838">引用与溯源 （这个是 RAG 的特色功能）</span></li></ol><ul list="u9247ad74" data-lake-indent="1"><li fid="u76d1cd14" data-lake-id="u776f663a" id="u776f663a"><span data-lake-id="u173b0b99" id="u173b0b99">便于定位信息的具体来源</span></li></ul><ul list="u0ff7119c" start="2" data-lake-indent="1"><li fid="u18f59443" data-lake-id="ub0c26518" id="ub0c26518"><span data-lake-id="u7d2f9488" id="u7d2f9488">可以给出更精确的引用范围</span></li></ul><ul list="u83df07e7" start="3" data-lake-indent="1"><li fid="u8a6df3be" data-lake-id="u9e89c83d" id="u9e89c83d"><span data-lake-id="ufa00c249" id="ufa00c249">有助于用户验证答案的可靠性</span></li></ul><h4 data-lake-id="lcmtx" id="lcmtx"><span data-lake-id="ub26a861e" id="ub26a861e">3.1.2 常见的分块策略</span></h4><ol list="ucfcb14e6"><li fid="u1d2e50db" data-lake-id="ubc4832cc" id="ubc4832cc"><span data-lake-id="u34712841" id="u34712841">固定长度分块</span></li></ol><ul list="u6ba9f6d9" data-lake-indent="1"><li fid="ufb52576d" data-lake-id="u807238aa" id="u807238aa"><span data-lake-id="uf21171e4" id="uf21171e4">按字符数或 token 数进行切分</span></li></ul><ul list="ube23e047" start="2" data-lake-indent="1"><li fid="uaa740eb0" data-lake-id="u285c9912" id="u285c9912"><span data-lake-id="uafb1fbf8" id="uafb1fbf8">实现简单，但可能切断语义完整的段落</span></li></ul><ul list="u94da6ec7" start="3" data-lake-indent="1"><li fid="ue4948c69" data-lake-id="u4b23d3f1" id="u4b23d3f1"><span data-lake-id="u75059fc8" id="u75059fc8">适合结构统一的文档</span></li></ul><ol list="u8236ae4c" start="2"><li fid="uebf8ae5c" data-lake-id="u5ddd5a47" id="u5ddd5a47"><span data-lake-id="ufb46a277" id="ufb46a277">语义分块</span></li></ol><ul list="u6f399569" data-lake-indent="1"><li fid="u7c8e9314" data-lake-id="u991c71ac" id="u991c71ac"><span data-lake-id="u346bdcbd" id="u346bdcbd">按段落、章节等自然语义单位切分</span></li></ul><ul list="u6c554df7" start="2" data-lake-indent="1"><li fid="u27615c55" data-lake-id="u7291bf0f" id="u7291bf0f"><span data-lake-id="ud5a128b6" id="ud5a128b6">保持上下文的连贯性</span></li></ul><ul list="udc86e3f9" start="3" data-lake-indent="1"><li fid="ubee8b902" data-lake-id="ub619abad" id="ub619abad"><span data-lake-id="u89f6b2b7" id="u89f6b2b7">需要考虑文档的具体结构</span></li></ul><ol list="u6a431253" start="3"><li fid="u7ddfce68" data-lake-id="u8fa0c304" id="u8fa0c304"><span data-lake-id="u710cbd80" id="u710cbd80">重叠分块</span></li></ol><ul list="ua2211229" data-lake-indent="1"><li fid="ud71f764a" data-lake-id="u41b6e12c" id="u41b6e12c"><span data-lake-id="u58d8e51a" id="u58d8e51a">相邻块之间保留一定重叠</span></li></ul><ul list="u99cf69b1" start="2" data-lake-indent="1"><li fid="u70bf705a" data-lake-id="u9762b397" id="u9762b397"><span data-lake-id="u359d0e79" id="u359d0e79">避免关键信息被切分</span></li></ul><ul list="ucb381b1a" start="3" data-lake-indent="1"><li fid="ua0ac4978" data-lake-id="ue04de7b6" id="ue04de7b6"><span data-lake-id="u123323f3" id="u123323f3">增加了存储和计算开销</span></li></ul><ol list="u8886b327" start="4"><li fid="u5325019c" data-lake-id="u7466dfd5" id="u7466dfd5"><span data-lake-id="u7820f180" id="u7820f180">递归分块</span></li></ol><ul list="u96df5c4d" data-lake-indent="1"><li fid="uff587402" data-lake-id="ud16071ef" id="ud16071ef"><span data-lake-id="u07a70293" id="u07a70293">先大块后细分</span></li></ul><ul list="uff6fdec8" start="2" data-lake-indent="1"><li fid="u72356973" data-lake-id="u5537d156" id="u5537d156"><span data-lake-id="u95b757ef" id="u95b757ef">保持层次结构</span></li></ul><ul list="ue6879e0a" start="3" data-lake-indent="1"><li fid="ued7fb814" data-lake-id="uf418da7d" id="uf418da7d"><span data-lake-id="u7b45d840" id="u7b45d840">适合长文档处理</span></li></ul><p data-lake-id="u9c087476" id="u9c087476"><span data-lake-id="u853601a4" id="u853601a4">选择合适的分块策略需要考虑：</span></p><ul list="u2f9b0d07"><li fid="u519ce67b" data-lake-id="ua94ac12a" id="ua94ac12a"><span data-lake-id="u13c9fbdd" id="u13c9fbdd">文档的类型和结构</span></li></ul><ul list="u74b6ead7" start="2"><li fid="u0652af1e" data-lake-id="u3b9aadfa" id="u3b9aadfa"><span data-lake-id="ue52d34d0" id="ue52d34d0">向量数据库的特性</span></li></ul><ul list="u154b1d0a" start="3"><li fid="u988aff65" data-lake-id="ua293f583" id="ua293f583"><span data-lake-id="u1ecb9120" id="u1ecb9120">LLM 的上下文窗口大小</span></li></ul><ul list="ua5069851" start="4"><li fid="u56daab34" data-lake-id="ufa6be085" id="ufa6be085"><span data-lake-id="uf11d2f8d" id="uf11d2f8d">检索效率与成本的平衡</span></li></ul><p data-lake-id="u7c3600d6" id="u7c3600d6"><span data-lake-id="u73c8cc6e" id="u73c8cc6e">例如如果是 markdown，可以按段落进行分块，如果是一般文档，可以按章节进行分块。</span></p><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22latex%22%2C%22code%22%3A%22%2B--------------------------------------------------%2B%5Cn%7C%20%20%23%20Chapter%201%20Title%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20Main%20content...%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20Main%20content...%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20%23%23%201.1%20Section%20Title%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20-%20List%20item%201%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20-%20List%20item%202%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20%23%23%23%201.1.1%20Subsection%20Title%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20Main%20paragraph...%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20%23%20Chapter%202%20Title%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%20Another%20paragraph...%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%2B--------------------------------------------------%2B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Chunking%20%E5%88%87%E7%89%87%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20v%5Cn%2B------------------%2B%20%20%2B-------------------%2B%20%20%2B------------------%2B%5Cn%7C%20Chunk%201%3A%20%20%20%20%20%20%20%20%20%7C%20%20%7C%20Chunk%202%3A%20%20%20%20%20%20%20%20%20%20%7C%20%20%7C%20Chunk%203%3A%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20%23%20Chapter%201%20%20%20%20%20%20%7C%20%20%7C%20%23%23%201.1%20Section%20%20%20%20%7C%20%20%7C%20%23%20Chapter%202%20%20%20%20%20%20%7C%5Cn%7C%20Title%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%7C%20Title%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%7C%20Title%20%20%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20Main%20content...%20%20%7C%20%20%7C%20-%20List%20item%201%20%20%20%20%20%7C%20%20%7C%20Another%20%20%20%20%20%20%20%20%20%20%7C%5Cn%7C%20Main%20content...%20%20%7C%20%20%7C%20-%20List%20item%202%20%20%20%20%20%7C%20%20%7C%20paragraph...%20%20%20%20%20%7C%5Cn%2B------------------%2B%20%20%7C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%20%2B------------------%2B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20%23%23%23%201.1.1%20%20%20%20%20%20%20%20%20%7C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20Subsection%20Title%20%20%7C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%20Main%20paragraph...%20%7C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2B-------------------%2B%5Cn%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22dOBEt%22%7D"></card><h3 data-lake-id="z1psB" id="z1psB"><span data-lake-id="ub619360a" id="ub619360a">3.2 文本向量化 (Embedding)</span></h3><p data-lake-id="u6dbf8487" id="u6dbf8487"><span data-lake-id="uea0a5b1f" id="uea0a5b1f">文本向量化是将自然语言文本转换为高维向量空间中的数值向量的过程。这种转换使得我们可以：</span></p><ul list="u4ef3016e"><li fid="u97ee2c0d" data-lake-id="u9b818903" id="u9b818903"><span data-lake-id="ue4945e9f" id="ue4945e9f">用数学方法计算文本之间的语义相似度</span></li></ul><ul list="uc153560d" start="2"><li fid="u69fc6e50" data-lake-id="ueb507df2" id="ueb507df2"><span data-lake-id="u9c0cc8c1" id="u9c0cc8c1">在向量空间中进行高效的相似度搜索</span></li></ul><ul list="u44e7aaea" start="3"><li fid="uf196822f" data-lake-id="u19e6b86f" id="u19e6b86f"><span data-lake-id="u3a0337c1" id="u3a0337c1">保留文本的语义信息和上下文关系</span></li></ul><p data-lake-id="uf9d1d87f" id="uf9d1d87f"><span data-lake-id="udf772a66" id="udf772a66">常用的文本向量化模型包括：</span></p><ol list="ua10164d7"><li fid="u8ea6b669" data-lake-id="uacd0504a" id="uacd0504a"><span data-lake-id="ueb38d251" id="ueb38d251">OpenAI Embeddings</span></li></ol><ul list="u2d19e280" data-lake-indent="1"><li fid="u0553d3dc" data-lake-id="udbd6cb9c" id="udbd6cb9c"><span data-lake-id="u0d6dc94e" id="u0d6dc94e">text-embedding-ada-002 模型</span></li></ul><ul list="u237e4c0f" start="2" data-lake-indent="1"><li fid="ud9d48c6e" data-lake-id="uc9e1dfc5" id="uc9e1dfc5"><span data-lake-id="ua028c6ab" id="ua028c6ab">1536 维向量输出</span></li></ul><ul list="u8eef4f32" start="3" data-lake-indent="1"><li fid="u3630d81c" data-lake-id="uc73b497f" id="uc73b497f"><span data-lake-id="u26d705c8" id="u26d705c8">适用于英文等多种语言</span></li></ul><ul list="ufbe04758" start="4" data-lake-indent="1"><li fid="uc8f0b2d2" data-lake-id="udc94e280" id="udc94e280"><span data-lake-id="u7d43c685" id="u7d43c685">语义表达能力强</span></li></ul><ol list="u88a66bc0" start="2"><li fid="u51a7f1f5" data-lake-id="u456dbd25" id="u456dbd25"><span data-lake-id="u6b26c56f" id="u6b26c56f">Sentence Transformers</span></li></ol><ul list="ub8d1f359" data-lake-indent="1"><li fid="u4629af24" data-lake-id="u23f42c5e" id="u23f42c5e"><span data-lake-id="uc03b6425" id="uc03b6425">开源的句子级别编码器</span></li></ul><ul list="ufb8939c7" start="2" data-lake-indent="1"><li fid="ua6388285" data-lake-id="uf3ab9d27" id="uf3ab9d27"><span data-lake-id="u6eff278c" id="u6eff278c">支持多语言</span></li></ul><ul list="udaf0d4fd" start="3" data-lake-indent="1"><li fid="u60ea1975" data-lake-id="ub15546f6" id="ub15546f6"><span data-lake-id="ub7a2f9f3" id="ub7a2f9f3">可以根据场景微调</span></li></ul><ul list="uc762e236" start="4" data-lake-indent="1"><li fid="u20788637" data-lake-id="ua4160f3c" id="ua4160f3c"><span data-lake-id="u96bdd66a" id="u96bdd66a">计算效率高</span></li></ul><p data-lake-id="uba777bc0" id="uba777bc0"><span data-lake-id="u96b5aa9c" id="u96b5aa9c">在 RAG Web UI 中，主要是用的 OpenAI 的 text-embedding-ada-002 模型。</span></p><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22python%22%2C%22code%22%3A%22from%20langchain_openai%20import%20OpenAIEmbeddings%5Cn...%5Cn%5Cnembeddings%20%3D%20OpenAIEmbeddings(%5Cn%20%20%20%20openai_api_key%3Dsettings.OPENAI_API_KEY%2C%5Cn%20%20%20%20openai_api_base%3Dsettings.OPENAI_API_BASE%5Cn)%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22jKiPE%22%7D"></card><h3 data-lake-id="cqjWs" id="cqjWs"><span data-lake-id="u1510d2c2" id="u1510d2c2">3.3 向量数据库</span></h3><p data-lake-id="uc714df9a" id="uc714df9a"><span data-lake-id="u14862e29" id="u14862e29">在文本 Embedding 之后，需要将向量存储到向量数据库中，以便后续的检索和相似度计算。</span></p><p data-lake-id="u6ab6d76c" id="u6ab6d76c"><span data-lake-id="u6d542067" id="u6d542067">在 RAG Web UI 中，主要是用的 ChromaDB 作为向量数据库， 同时支持使用 Factory 模式， 支持多种向量数据库，例如：</span></p><ol list="u66f18c45"><li fid="u7ebce84b" data-lake-id="u67346d96" id="u67346d96"><span data-lake-id="u982180bd" id="u982180bd">ChromaDB</span></li></ol><ol list="udddedfe0" start="2"><li fid="ue5bc06cb" data-lake-id="ub6804c66" id="ub6804c66"><span data-lake-id="u3e17ec37" id="u3e17ec37">Qdrant</span></li></ol><ol list="uef51c90a" start="3"><li fid="ue10d4b13" data-lake-id="u2e65fe5a" id="u2e65fe5a"><span data-lake-id="ueb4f19a5" id="ueb4f19a5">Milvus</span></li></ol><ol list="u47759cf9" start="4"><li fid="u602287c4" data-lake-id="ufd172825" id="ufd172825"><span data-lake-id="uf8e7b119" id="uf8e7b119">Faiss</span></li></ol><ol list="uc15a5d44" start="5"><li fid="ua0773127" data-lake-id="u7c10a563" id="u7c10a563"><span data-lake-id="u3703f966" id="u3703f966">Annoy</span></li></ol><ol list="ubeafbe0a" start="6"><li fid="u65ca6b8a" data-lake-id="u7d097413" id="u7d097413"><span data-lake-id="ub34f9b28" id="ub34f9b28">Pinecone</span></li></ol><ol list="udea38194" start="7"><li fid="ua9413b50" data-lake-id="u29d681d7" id="u29d681d7"><span data-lake-id="ub7c6a0cf" id="ub7c6a0cf">Zilliz</span></li></ol><p data-lake-id="ua5dc6593" id="ua5dc6593"><span data-lake-id="u41ad1372" id="u41ad1372">向量数据库除了存储向量，还要携带某些元信息(文档来源、段落位置等)方便查阅， 一般情况下，我们会存入这样的数据结构到向量数据库中：</span></p><p data-lake-id="u1827104e" id="u1827104e"><span data-lake-id="u83f7435f" id="u83f7435f">除了向量之外， 我们还需要存入一些元数据， 例如：</span></p><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22python%22%2C%22code%22%3A%22%7B%5Cn%20%20%20%20%5C%22id%5C%22%3A%20%5C%22chunk_id%5C%22%2C%5Cn%20%20%20%20%5C%22text%5C%22%3A%20%5C%22%E6%AE%B5%E8%90%BD%E5%86%85%E5%AE%B9%5C%22%2C%5Cn%20%20%20%20%5C%22metadata%5C%22%3A%20%7B%5C%22source%5C%22%3A%20%5C%22%E6%96%87%E6%A1%A3%E6%9D%A5%E6%BA%90%5C%22%2C%20%5C%22position%5C%22%3A%20%5C%22%E6%AE%B5%E8%90%BD%E4%BD%8D%E7%BD%AE%5C%22%2C%20%5C%22hash%5C%22%3A%20%5C%22%E6%AE%B5%E8%90%BD%E5%93%88%E5%B8%8C%E5%80%BC%5C%22%7D%5Cn%7D%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22Ht1EG%22%7D"></card><h2 data-lake-id="MJj9Z" id="MJj9Z"><span data-lake-id="ud5ffaec1" id="ud5ffaec1">4. 检索与重排序：用最相关的上下文喂给大模型</span></h2><h3 data-lake-id="vLVAL" id="vLVAL"><span data-lake-id="uf3f1c5e4" id="uf3f1c5e4">4.1 相似度检索 (Similarity Search)</span></h3><p data-lake-id="u24c479e1" id="u24c479e1"><span data-lake-id="ucdbb03da" id="ucdbb03da">常用的相似度度量：余弦相似度、向量距离 (欧几里得距离) 等。</span></p><p data-lake-id="u24bb5aa7" id="u24bb5aa7"><span data-lake-id="ub39be0c6" id="ub39be0c6">ChromaDB 支持多种相似度计算方法:</span></p><ol list="ue0b19ef3"><li fid="u3cab19a2" data-lake-id="u0e93f1fb" id="u0e93f1fb"><span data-lake-id="ua20649ea" id="ua20649ea">Cosine Similarity (余弦相似度)</span></li></ol><ul list="udca7a32c" data-lake-indent="1"><li fid="u08e22d2c" data-lake-id="u5364e4f2" id="u5364e4f2"><span data-lake-id="u046b3dde" id="u046b3dde">计算两个向量夹角的余弦值</span></li></ul><ul list="u310c0e39" start="2" data-lake-indent="1"><li fid="u0fa9eb7c" data-lake-id="uc3f00a22" id="uc3f00a22"><span data-lake-id="ubbe5b525" id="ubbe5b525">值域范围为 [-1,1]，越接近 1 表示越相似</span></li></ul><ul list="ud1b306c2" start="3" data-lake-indent="1"><li fid="u4ea3f81f" data-lake-id="uf41e322a" id="uf41e322a"><span data-lake-id="u95ede27f" id="u95ede27f">不受向量长度影响，只关注方向</span></li></ul><ul list="ud9a52d99" start="4" data-lake-indent="1"><li fid="u5e0c52a9" data-lake-id="u742c410e" id="u742c410e"><span data-lake-id="uc013d16f" id="uc013d16f">计算公式: cos(θ) = (A·B)/(||A||·||B||)</span></li></ul><ol list="u360af888" start="2"><li fid="u289c8dc8" data-lake-id="u556d8d81" id="u556d8d81"><span data-lake-id="u13cf51a8" id="u13cf51a8">L2 Distance (欧氏距离)</span></li></ol><ul list="u52f86b11" data-lake-indent="1"><li fid="u1bd0f138" data-lake-id="u5890a1ef" id="u5890a1ef"><span data-lake-id="u4447b600" id="u4447b600">计算两个向量间的直线距离</span></li></ul><ul list="uc7662156" start="2" data-lake-indent="1"><li fid="u1a7170c7" data-lake-id="u58b967f9" id="u58b967f9"><span data-lake-id="u43c536aa" id="u43c536aa">值越小表示越相似</span></li></ul><ul list="uc6249595" start="3" data-lake-indent="1"><li fid="uffb7febc" data-lake-id="udab5d676" id="udab5d676"><span data-lake-id="u0ec8d59f" id="u0ec8d59f">受向量长度影响</span></li></ul><ul list="u3aa1ba0e" start="4" data-lake-indent="1"><li fid="ue23366f8" data-lake-id="u3bf62153" id="u3bf62153"><span data-lake-id="u798edbd7" id="u798edbd7">计算公式: d = √(Σ(ai-bi)²)</span></li></ul><ol list="u06ec6fcf" start="3"><li fid="u40a37ef7" data-lake-id="u00be76e6" id="u00be76e6"><span data-lake-id="ud96c0392" id="ud96c0392">IP (Inner Product, 内积)</span></li></ol><ul list="ue767cd63" data-lake-indent="1"><li fid="u65f91265" data-lake-id="u2c926977" id="u2c926977"><span data-lake-id="ud092cf8c" id="ud092cf8c">两个向量对应位置相乘后求和</span></li></ul><ul list="u6f1d97a9" start="2" data-lake-indent="1"><li fid="ub167d17a" data-lake-id="u78fcc9a0" id="u78fcc9a0"><span data-lake-id="u2cc07429" id="u2cc07429">值越大表示越相似</span></li></ul><ul list="ue30e697a" start="3" data-lake-indent="1"><li fid="u43738d26" data-lake-id="u8c0900a0" id="u8c0900a0"><span data-lake-id="uaf97ae87" id="uaf97ae87">受向量长度影响</span></li></ul><ul list="u2b1665e5" start="4" data-lake-indent="1"><li fid="u006fc9f1" data-lake-id="ue4186820" id="ue4186820"><span data-lake-id="u74441043" id="u74441043">计算公式: IP = Σ(ai×bi)</span></li></ul><p data-lake-id="u2243c7da" id="u2243c7da"><span data-lake-id="u9186e699" id="u9186e699">ChromaDB 默认使用 Cosine Similarity，这也是最常用的相似度计算方法，因为:</span></p><ul list="ud35eb0fc"><li fid="u605d0642" data-lake-id="u5359652b" id="u5359652b"><span data-lake-id="u16141e9d" id="u16141e9d">计算简单高效</span></li></ul><ul list="uc31c639b" start="2"><li fid="u27d04e1e" data-lake-id="uddfa2408" id="uddfa2408"><span data-lake-id="ua45df39f" id="ua45df39f">不受向量绝对大小影响</span></li></ul><ul list="u5704671b" start="3"><li fid="ubc53f71f" data-lake-id="u61010602" id="u61010602"><span data-lake-id="u3d4d1ad2" id="u3d4d1ad2">对于文本语义相似度计算效果好</span></li></ul><ul list="ubcad9153" start="4"><li fid="ub2f85303" data-lake-id="u0f5bd1b8" id="u0f5bd1b8"><span data-lake-id="u204d689f" id="u204d689f">结果容易解释和标准化</span></li></ul><p data-lake-id="uaebf4578" id="uaebf4578"><span data-lake-id="uedbe1095" id="uedbe1095">在实际使用中，可以根据具体场景选择合适的相似度算法:</span></p><ul list="u1a8cb8c5"><li fid="uffb55178" data-lake-id="uad930fcf" id="uad930fcf"><span data-lake-id="ua0568997" id="ua0568997">如果向量已归一化，三种方法等价</span></li></ul><ul list="u80d8d0f6" start="2"><li fid="ubc9b7fac" data-lake-id="uba954aec" id="uba954aec"><span data-lake-id="u180a0d5f" id="u180a0d5f">对向量长度敏感时选择 Cosine</span></li></ul><ul list="u4e0a52b2" start="3"><li fid="ubeb35e67" data-lake-id="u460878cc" id="u460878cc"><span data-lake-id="u81272daa" id="u81272daa">关注绝对距离时选择 L2</span></li></ul><ul list="u2e7b6aab" start="4"><li fid="u675029f5" data-lake-id="u373a26e9" id="u373a26e9"><span data-lake-id="udc3e9197" id="udc3e9197">需要快速计算时可用 IP</span></li></ul><h3 data-lake-id="iDXmp" id="iDXmp"><span data-lake-id="ud3f51962" id="ud3f51962">4.2 重排序 (Re-ranking) 重要吗？</span></h3><p data-lake-id="u1ffcd59f" id="u1ffcd59f"><span data-lake-id="u6a1d1eea" id="u6a1d1eea">重排序是一个重要的步骤，可以显著提升检索结果的质量。其工作原理如下：</span></p><ol list="u1b2fdb19"><li fid="u0237c6eb" data-lake-id="u02b5fe86" id="u02b5fe86"><span data-lake-id="u3c938058" id="u3c938058">初步检索</span></li></ol><ul list="u519b4983" data-lake-indent="1"><li fid="uc92f549f" data-lake-id="uad05ed9f" id="uad05ed9f"><span data-lake-id="u83eb87bd" id="u83eb87bd">首先使用向量相似度搜索召回一批候选文档(如前20-100条)</span></li></ul><ul list="u62fc93bb" start="2" data-lake-indent="1"><li fid="u7444f97f" data-lake-id="u8e4edb9b" id="u8e4edb9b"><span data-lake-id="uc95ae060" id="uc95ae060">这一步计算快速但可能不够精确</span></li></ul><ol list="u0eda5ffc" start="2"><li fid="ud4378917" data-lake-id="uc37d0269" id="uc37d0269"><span data-lake-id="ub18b2f03" id="ub18b2f03">Cross-Encoder 重排序</span></li></ol><ul list="udab252d8" data-lake-indent="1"><li fid="u94489a09" data-lake-id="uca0ca1b0" id="uca0ca1b0"><span data-lake-id="u15f66f01" id="u15f66f01">对召回的候选文档进行更精细的相关性打分</span></li></ul><ul list="u7d81fe14" start="2" data-lake-indent="1"><li fid="u9b640fe1" data-lake-id="u1dd10b24" id="u1dd10b24"><span data-lake-id="uef6ef812" id="uef6ef812">Cross-Encoder 会同时看到 query 和文档内容，计算它们的匹配度</span></li></ul><ul list="ue1f115db" start="3" data-lake-indent="1"><li fid="u099dfe72" data-lake-id="u72e028a3" id="u72e028a3"><span data-lake-id="u3d0a37bb" id="u3d0a37bb">相比向量相似度，能更好地理解语义关联</span></li></ul><ul list="uc98b8b60" start="4" data-lake-indent="1"><li fid="u2eee4848" data-lake-id="uff36216f" id="uff36216f"><span data-lake-id="u58022611" id="u58022611">但计算开销较大，所以只用于重排少量候选</span></li></ul><ol list="uba0cd39e" start="3"><li fid="ue23d74cd" data-lake-id="uca4823fe" id="uca4823fe"><span data-lake-id="ub7a3c067" id="ub7a3c067">应用场景</span></li></ol><ul list="u41ce6e67" data-lake-indent="1"><li fid="ua73fbfff" data-lake-id="u394dcba4" id="u394dcba4"><span data-lake-id="uc64515a6" id="uc64515a6">多路召回：不同检索方式召回的结果需要统一排序</span></li></ul><ul list="ub4178e2b" start="2" data-lake-indent="1"><li fid="u562fe528" data-lake-id="u2d4a3d6c" id="u2d4a3d6c"><span data-lake-id="u4795ed0c" id="u4795ed0c">高精度要求：需要更准确的相关性排序</span></li></ul><ul list="u5b7b2aa7" start="3" data-lake-indent="1"><li fid="u8ab255e2" data-lake-id="u34fa4f7e" id="u34fa4f7e"><span data-lake-id="uacd329df" id="uacd329df">复杂查询：简单向量相似度可能不足以理解查询意图</span></li></ul><ol list="ufec485f6" start="4"><li fid="uc13d35f4" data-lake-id="ufaafe50a" id="ufaafe50a"><span data-lake-id="u3ed8fe28" id="u3ed8fe28">常见实现</span></li></ol><ul list="u596a53ce" data-lake-indent="1"><li fid="u4c348ecf" data-lake-id="u297023a5" id="u297023a5"><span data-lake-id="u4e34ef2b" id="u4e34ef2b">使用预训练的 Cross-Encoder 模型(如 BERT)</span></li></ul><ul list="ucbf64f6c" start="2" data-lake-indent="1"><li fid="u2ac6a506" data-lake-id="u4e8b4d3e" id="u4e8b4d3e"><span data-lake-id="ub662f3b5" id="ub662f3b5">可以针对具体任务进行微调</span></li></ul><ul list="u3a75ab0f" start="3" data-lake-indent="1"><li fid="ucc2f8fef" data-lake-id="ud57dc71d" id="ud57dc71d"><span data-lake-id="u7acf104b" id="u7acf104b">输出相关性分数用于重新排序</span></li></ul><p data-lake-id="uf79d48c6" id="uf79d48c6"><span data-lake-id="u4742d562" id="u4742d562">虽然重排序会增加一定延迟，但在对准确度要求较高的场景下，这个成本通常是值得的。</span></p><h3 data-lake-id="PUZCH" id="PUZCH"><span data-lake-id="ufdf9ceb0" id="ufdf9ceb0">4.3 拼接上下文与用户问题</span></h3><p data-lake-id="ub85c38da" id="ub85c38da"><span data-lake-id="u828fca52" id="u828fca52">在检索到相关文档片段后，需要将它们与用户问题拼接成合适的 prompt，以供 LLM 生成回答。</span></p><p data-lake-id="u7f2a2f0c" id="u7f2a2f0c"><span data-lake-id="uafc12c04" id="uafc12c04">用户问题 + 检索到的上下文 = Prompt，最终由 LLM 输出回答。</span></p><p data-lake-id="uc165540b" id="uc165540b"><span data-lake-id="u80cc689e" id="u80cc689e">以下是一些常见的拼接策略：</span></p><ol list="uf0343259"><li fid="u2bb0f01b" data-lake-id="udcee1b97" id="udcee1b97"><span data-lake-id="u9005ec6e" id="u9005ec6e">基本结构</span></li></ol><ul list="u70b0c871" data-lake-indent="1"><li fid="u922e9ad4" data-lake-id="u6db1b456" id="u6db1b456"><span data-lake-id="u604b55c4" id="u604b55c4">System: 系统指令，说明 AI 助手的角色和任务</span></li></ul><ul list="u96d73fa4" start="2" data-lake-indent="1"><li fid="ucb5dd5a7" data-lake-id="uaf6c06eb" id="uaf6c06eb"><span data-lake-id="ucbdbb219" id="ucbdbb219">Context: 检索到的相关文档片段</span></li></ul><ul list="uf212c435" start="3" data-lake-indent="1"><li fid="u6177730c" data-lake-id="u8e9b981d" id="u8e9b981d"><span data-lake-id="u27557faf" id="u27557faf">Human: 用户的实际问题</span></li></ul><ul list="ua282c958" start="4" data-lake-indent="1"><li fid="u7fac34d1" data-lake-id="u80d06ad6" id="u80d06ad6"><span data-lake-id="u5d087b14" id="u5d087b14">Assistant: AI 的回答</span></li></ul><ol list="u5e50b6af" start="2"><li fid="u754de733" data-lake-id="u11538fe1" id="u11538fe1"><span data-lake-id="uc17e030e" id="uc17e030e">拼接技巧</span></li></ol><p data-lake-id="u12b34bb4" id="u12b34bb4"><span data-lake-id="u06bce8d6" id="u06bce8d6">我们在项目中做了一个有意思的事情，就是可以使用 </span><code data-lake-id="ua5e8ec8d" id="ua5e8ec8d"><span data-lake-id="u6cec0f29" id="u6cec0f29">[[citation:1]]</span></code><span data-lake-id="u6c75f367" id="u6c75f367"> 这样的格式来引用检索到的上下文。</span></p><p data-lake-id="u325a1a0a" id="u325a1a0a"><span data-lake-id="uce25db5c" id="uce25db5c">然后用户可以在前端通过 Markdown 的格式来展示引用信息, 并且通过弹窗来展示引用详情。</span></p><p data-lake-id="u5922ec42" id="u5922ec42"><br></p><p data-lake-id="u7f5e8322" id="u7f5e8322"><span data-lake-id="ubf5abcc2" id="ubf5abcc2">在 RAG Web UI 中， 我们使用 LangChain 的模板来实现这个功能：</span></p><p data-lake-id="uea2fb41f" id="uea2fb41f"><span data-lake-id="udd9914da" id="udd9914da">可查阅： </span><code data-lake-id="u439ac4a3" id="u439ac4a3"><span data-lake-id="u79c94ef2" id="u79c94ef2">backend/app/services/chat_service.py</span></code></p><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22python%22%2C%22code%22%3A%22from%20langchain.prompts%20import%20PromptTemplate%5Cn%5Cnqa_system_prompt%20%3D%20(%5Cn%20%20%20%20%20%20%5C%22You%20are%20given%20a%20user%20question%2C%20and%20please%20write%20clean%2C%20concise%20and%20accurate%20answer%20to%20the%20question.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22You%20will%20be%20given%20a%20set%20of%20related%20contexts%20to%20the%20question%2C%20which%20are%20numbered%20sequentially%20starting%20from%201.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22Each%20context%20has%20an%20implicit%20reference%20number%20based%20on%20its%20position%20in%20the%20array%20(first%20context%20is%201%2C%20second%20is%202%2C%20etc.).%20%5C%22%5Cn%20%20%20%20%20%20%5C%22Please%20use%20these%20contexts%20and%20cite%20them%20using%20the%20format%20%5Bcitation%3Ax%5D%20at%20the%20end%20of%20each%20sentence%20where%20applicable.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22Your%20answer%20must%20be%20correct%2C%20accurate%20and%20written%20by%20an%20expert%20using%20an%20unbiased%20and%20professional%20tone.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22Please%20limit%20to%201024%20tokens.%20Do%20not%20give%20any%20information%20that%20is%20not%20related%20to%20the%20question%2C%20and%20do%20not%20repeat.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22Say%20'information%20is%20missing%20on'%20followed%20by%20the%20related%20topic%2C%20if%20the%20given%20context%20do%20not%20provide%20sufficient%20information.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22If%20a%20sentence%20draws%20from%20multiple%20contexts%2C%20please%20list%20all%20applicable%20citations%2C%20like%20%5Bcitation%3A1%5D%5Bcitation%3A2%5D.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22Other%20than%20code%20and%20specific%20names%20and%20citations%2C%20your%20answer%20must%20be%20written%20in%20the%20same%20language%20as%20the%20question.%20%5C%22%5Cn%20%20%20%20%20%20%5C%22Be%20concise.%5C%5Cn%5C%5CnContext%3A%20%7Bcontext%7D%5C%5Cn%5C%5Cn%5C%22%5Cn%20%20%20%20%20%20%5C%22Remember%3A%20Cite%20contexts%20by%20their%20position%20number%20(1%20for%20first%20context%2C%202%20for%20second%2C%20etc.)%20and%20don't%20blindly%20%5C%22%5Cn%20%20%20%20%20%20%5C%22repeat%20the%20contexts%20verbatim.%5C%22%5Cn%20%20)%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22ov0XS%22%7D"></card><h2 data-lake-id="VipQd" id="VipQd"><span data-lake-id="u5f1be42f" id="u5f1be42f">5. 工程实战示例：RAG 在知识库 QA 中的流程</span></h2><p data-lake-id="u1570760c" id="u1570760c"><span data-lake-id="ub0296d12" id="ub0296d12">理论的事情，相信大家都了解了，相信大家也看过不少的文章，但是可能没有真正动手实践过，或者项目太复杂无从下手，或是没有一个完整的项目可以参考。</span></p><p data-lake-id="u73f4d0a9" id="u73f4d0a9"><span data-lake-id="ub38879d6" id="ub38879d6">在工程的实践中，去掉那些花里胡哨的东西， 直接上代码，直接上手实践，才是这个项目的意义所在。</span></p><p data-lake-id="u93563862" id="u93563862"><span data-lake-id="ucaab6706" id="ucaab6706">这个项目中，用的都是目前最为流行的技术栈， 例如：</span></p><ul list="u876e09e1"><li fid="uf84dae33" data-lake-id="u0199bca3" id="u0199bca3"><span data-lake-id="u2f74807f" id="u2f74807f">前端：React（Nextjs） + TailwindCSS + AI SDK</span></li></ul><ul list="u5ba3bb8c" start="2"><li fid="uce50bb62" data-lake-id="uff131775" id="uff131775"><span data-lake-id="ud0428a45" id="ud0428a45">后端：FastAPI + LangChain + ChromaDB/Qdrant + MySQL + MinIO</span></li></ul><ul list="u6edda088" start="3"><li fid="u71afde1a" data-lake-id="u3d0693de" id="u3d0693de"><span data-lake-id="u3b4bc246" id="u3b4bc246">部署：Docker + Docker Compose</span></li></ul><p data-lake-id="u64fdd719" id="u64fdd719"><span data-lake-id="u02df0f58" id="u02df0f58">让我们通过一个完整的工程实现示例，来理解 RAG 在知识库问答中的具体应用流程。我们将按照数据流的顺序，逐步解析关键代码的实现。</span></p><h3 data-lake-id="gPGWx" id="gPGWx"><span data-lake-id="u3dd8a60a" id="u3dd8a60a">5.1 文档上传 → 异步处理</span></h3><p data-lake-id="u67bfe568" id="u67bfe568"><span data-lake-id="ufb342ef0" id="ufb342ef0">详细代码可以参考： </span><code data-lake-id="u0152ee55" id="u0152ee55"><span data-lake-id="u62712a44" id="u62712a44">backend/app/services/document_processor.py</span></code></p><p data-lake-id="u65e391ba" id="u65e391ba"><br></p><p data-lake-id="u0438db22" id="u0438db22"><span data-lake-id="u0c20b2d5" id="u0c20b2d5">从上面的系统架构图中可以看到，文档上传和处理的流程如下：</span></p><card type="block" name="diagram" value="data:%7B%22type%22%3A%22mermaid%22%2C%22code%22%3A%22sequenceDiagram%5Cn%20%20%20%20participant%20Client%5Cn%20%20%20%20participant%20API%5Cn%20%20%20%20participant%20NFS%5Cn%20%20%20%20participant%20Queue%5Cn%20%20%20%20participant%20Worker%5Cn%20%20%20%20participant%20VectorDB%5Cn%5Cn%20%20%20%20Client-%3E%3EAPI%3A%20%E4%B8%8A%E4%BC%A0%E6%96%87%E6%A1%A3%5Cn%20%20%20%20API-%3E%3ENFS%3A%20%E5%AD%98%E5%82%A8%E6%96%87%E6%A1%A3%5Cn%20%20%20%20API-%3E%3EQueue%3A%20%E5%88%9B%E5%BB%BA%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1%5Cn%20%20%20%20API--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%20Job%20ID%5Cn%5Cn%20%20%20%20loop%20%E7%8A%B6%E6%80%81%E6%9F%A5%E8%AF%A2%5Cn%20%20%20%20%20%20%20%20Client-%3E%3EAPI%3A%20%E6%9F%A5%E8%AF%A2%E8%BF%9B%E5%BA%A6%20(Job%20ID)%5Cn%20%20%20%20%20%20%20%20API--%3E%3EClient%3A%20%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86%E7%8A%B6%E6%80%81%5Cn%20%20%20%20end%5Cn%5Cn%20%20%20%20Queue-%3E%3EWorker%3A%20%E5%88%86%E5%8F%91%E4%BB%BB%E5%8A%A1%5Cn%20%20%20%20Worker-%3E%3ENFS%3A%20%E8%AF%BB%E5%8F%96%E6%96%87%E6%A1%A3%5Cn%20%20%20%20Worker-%3E%3EWorker%3A%20%E6%96%87%E6%9C%AC%E6%8F%90%E5%8F%96%5Cn%20%20%20%20Worker-%3E%3EWorker%3A%20%E6%96%87%E6%9C%AC%E5%88%86%E5%9D%97%5Cn%20%20%20%20Worker-%3E%3EWorker%3A%20%E5%90%91%E9%87%8F%E5%8C%96%E5%A4%84%E7%90%86%5Cn%20%20%20%20Worker-%3E%3EVectorDB%3A%20%E5%AD%98%E5%82%A8%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%5Cn%20%20%20%20Worker-%3E%3EQueue%3A%20%E6%9B%B4%E6%96%B0%E4%BB%BB%E5%8A%A1%E7%8A%B6%E6%80%81%22%2C%22url%22%3Anull%2C%22id%22%3A%22IvNRM%22%7D"></card><ol list="uce2c5e67"><li fid="u7fc1f1f4" data-lake-id="uac19e148" id="uac19e148"><span data-lake-id="u040b92fe" id="u040b92fe">用户上传文档 (PDF/MD/TXT/DOCX)</span></li></ol><ul list="ua4b7da67" data-lake-indent="1"><li fid="u668e30f8" data-lake-id="u94778968" id="u94778968"><span data-lake-id="u06b655fc" id="u06b655fc">客户端发起文档上传请求</span></li></ul><ul list="ue6e374eb" start="2" data-lake-indent="1"><li fid="u6a4d9a71" data-lake-id="u5a4f8805" id="u5a4f8805"><span data-lake-id="ud18f32c0" id="ud18f32c0">文档被临时存储到 NFS (Network File System)</span></li></ul><ul list="u4bfca2e9" start="3" data-lake-indent="1"><li fid="ue6af72ae" data-lake-id="uea132cae" id="uea132cae"><span data-lake-id="uefc6a871" id="uefc6a871">系统生成并返回一个 Job ID 给客户端</span></li></ul><ol list="ud630b735" start="2"><li fid="u04aebf6f" data-lake-id="u8155fb22" id="u8155fb22"><span data-lake-id="ud5267c68" id="ud5267c68">异步处理流程启动</span></li></ol><ul list="u377abbb0" data-lake-indent="1"><li fid="u86968a92" data-lake-id="u1daa3f9c" id="u1daa3f9c"><span data-lake-id="u6e39111a" id="u6e39111a">文档预处理：提取文本、清洗数据</span></li></ul><ul list="u990302c8" start="2" data-lake-indent="1"><li fid="ub9697556" data-lake-id="ud4990a6e" id="ud4990a6e"><span data-lake-id="uabc7fad3" id="uabc7fad3">文本分块：按照设定的策略进行分段</span></li></ul><ul list="u4132c314" start="3" data-lake-indent="1"><li fid="u51f46081" data-lake-id="u3c616cfe" id="u3c616cfe"><span data-lake-id="uf5195ec7" id="uf5195ec7">向量化：通过 Embedding 服务将文本转换为向量</span></li></ul><ul list="ue85dba47" start="4" data-lake-indent="1"><li fid="u3eb74b5a" data-lake-id="u4a54dacb" id="u4a54dacb"><span data-lake-id="u0f9bdec6" id="u0f9bdec6">存储：将向量数据保存到向量数据库</span></li></ul><ol list="u2b39d924" start="3"><li fid="u6c523f0a" data-lake-id="ue1be824f" id="ue1be824f"><span data-lake-id="ua9c47d90" id="ua9c47d90">状态查询</span></li></ol><ul list="u8e66cad8" data-lake-indent="1"><li fid="u354003c7" data-lake-id="ua3010f2b" id="ua3010f2b"><span data-lake-id="u60edc396" id="u60edc396">客户端通过 Job ID 轮询任务状态</span></li></ul><ul list="u4cf84ccf" start="2" data-lake-indent="1"><li fid="u6a882222" data-lake-id="uae9e1eb4" id="uae9e1eb4"><span data-lake-id="uf75f13e3" id="uf75f13e3">系统返回当前进度 (Processing/Completed/Failed)</span></li></ul><p data-lake-id="uc6ddde42" id="uc6ddde42"><span data-lake-id="u6c2675b5" id="u6c2675b5">这种异步处理的设计有以下优点：</span></p><ul list="u7b025630"><li fid="uf2943890" data-lake-id="u3bd87218" id="u3bd87218"><span data-lake-id="u8e79b204" id="u8e79b204">支持大文件处理：不会因处理时间过长导致请求超时</span></li></ul><ul list="ufa6c5af6" start="2"><li fid="u38a91ead" data-lake-id="u2e03605e" id="u2e03605e"><span data-lake-id="ud6eaac39" id="ud6eaac39">提升用户体验：用户可以实时查看处理进度</span></li></ul><ul list="ucab8f5e5" start="3"><li fid="ua1f9a299" data-lake-id="ubb263b57" id="ubb263b57"><span data-lake-id="u93e75fdd" id="u93e75fdd">系统解耦：文档处理与存储服务可以独立扩展</span></li></ul><ul list="u79ca229f" start="4"><li fid="u8d7c8958" data-lake-id="u0291d3dc" id="u0291d3dc"><span data-lake-id="u581a03ef" id="u581a03ef">错误处理：失败任务可以重试，不影响其他上传</span></li></ul><p data-lake-id="u9d2a5352" id="u9d2a5352"><span data-lake-id="u216e5a39" id="u216e5a39">在代码实现中，主要涉及以下几个关键组件：</span></p><ol list="u211db712"><li fid="ud1400d52" data-lake-id="ued033e61" id="ued033e61"><span data-lake-id="u22d4de3e" id="u22d4de3e">文件上传接口</span></li></ol><ol list="u1696d2fb" start="2"><li fid="u3e326f2b" data-lake-id="u0ec4d6d8" id="u0ec4d6d8"><span data-lake-id="u1da2d6bc" id="u1da2d6bc">任务队列系统</span></li></ol><ol list="u75b019f6" start="3"><li fid="u55a5a0f7" data-lake-id="u3cdd0027" id="u3cdd0027"><span data-lake-id="uf33034c7" id="uf33034c7">异步处理服务</span></li></ol><ol list="ua702af39" start="4"><li fid="u7e2d5f7b" data-lake-id="ubed24bf5" id="ubed24bf5"><span data-lake-id="ued355a72" id="ued355a72">状态查询接口</span></li></ol><p data-lake-id="ub941b1f3" id="ub941b1f3"><span data-lake-id="u19afd22d" id="u19afd22d">这种设计让整个文档处理流程更加健壮和可扩展。</span></p><p data-lake-id="ucd14a8f3" id="ucd14a8f3"><span data-lake-id="u51dfca89" id="u51dfca89">当然这里也设计也有设计到一些小细节，例如在处理文档的时候，可能很多系统都会选择先删后增，但是这样会导致向量数据库中的数据被删除，从而导致检索结果不准确。所以我们这里会通过一个临时表来实现这个功能，确保新的文件被处理后，旧的文件才被删除。</span></p><h3 data-lake-id="NfQ6k" id="NfQ6k"><span data-lake-id="ubc142663" id="ubc142663">5.2 用户提问 → 检索 + LLM 生成</span></h3><p data-lake-id="u53d0d88e" id="u53d0d88e"><span data-lake-id="u309734af" id="u309734af">代码可查阅： </span><code data-lake-id="u36a3a3a5" id="u36a3a3a5"><span data-lake-id="uf0a3425b" id="uf0a3425b">backend/app/services/chat_service.py</span></code></p><p data-lake-id="ufcef3ed1" id="ufcef3ed1"><span data-lake-id="uaf408313" id="uaf408313">从前端使用 AI SDK 发送到后台，后台接口接收后会进行，用户 Query 的处理流程如下:</span></p><card type="block" name="diagram" value="data:%7B%22type%22%3A%22mermaid%22%2C%22code%22%3A%22sequenceDiagram%5Cn%20%20%20%20actor%20User%5Cn%20%20%20%20participant%20Frontend%5Cn%20%20%20%20participant%20Backend%5Cn%20%20%20%20participant%20DB%5Cn%20%20%20%20participant%20VectorStore%5Cn%20%20%20%20participant%20LLM%5Cn%5Cn%20%20%20%20User-%3E%3EFrontend%3A%20%E5%8F%91%E9%80%81%E9%97%AE%E9%A2%98%5Cn%20%20%20%20Frontend-%3E%3EBackend%3A%20%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82%5Cn%20%20%20%20%5Cn%20%20%20%20rect%20rgb(200%2C%20220%2C%20250)%5Cn%20%20%20%20%20%20%20%20Note%20over%20Backend%3A%20%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8%E9%98%B6%E6%AE%B5%5Cn%20%20%20%20%20%20%20%20Backend-%3E%3EDB%3A%20%E5%AD%98%E5%82%A8%E7%94%A8%E6%88%B7%E9%97%AE%E9%A2%98(user%E7%B1%BB%E5%9E%8B)%5Cn%20%20%20%20%20%20%20%20Backend-%3E%3EDB%3A%20%E5%88%9B%E5%BB%BA%E7%A9%BAassistant%E8%AE%B0%E5%BD%95%5Cn%20%20%20%20end%5Cn%20%20%20%20%5Cn%20%20%20%20rect%20rgb(200%2C%20250%2C%20220)%5Cn%20%20%20%20%20%20%20%20Note%20over%20Backend%3A%20%E7%9F%A5%E8%AF%86%E5%BA%93%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%5Cn%20%20%20%20%20%20%20%20Backend-%3E%3EVectorStore%3A%20%E5%88%9D%E5%A7%8B%E5%8C%96%E5%90%91%E9%87%8F%E5%AD%98%E5%82%A8%5Cn%20%20%20%20%20%20%20%20Backend-%3E%3EVectorStore%3A%20%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E5%BA%93%5Cn%20%20%20%20end%5Cn%20%20%20%20%5Cn%20%20%20%20rect%20rgb(250%2C%20220%2C%20200)%5Cn%20%20%20%20%20%20%20%20Note%20over%20Backend%3A%20RAG%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5%5Cn%20%20%20%20%20%20%20%20Backend-%3E%3EVectorStore%3A%20%E6%89%A7%E8%A1%8C%E7%9B%B8%E4%BC%BC%E5%BA%A6%E6%A3%80%E7%B4%A2%5Cn%20%20%20%20%20%20%20%20VectorStore--%3E%3EBackend%3A%20%E8%BF%94%E5%9B%9E%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3%5Cn%20%20%20%20%20%20%20%20Backend-%3E%3ELLM%3A%20%E5%8F%91%E9%80%81%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8C%96%E9%97%AE%E9%A2%98%E8%AF%B7%E6%B1%82%5Cn%20%20%20%20%20%20%20%20LLM--%3E%3EBackend%3A%20%E8%BF%94%E5%9B%9E%E9%87%8D%E6%9E%84%E5%90%8E%E7%9A%84%E9%97%AE%E9%A2%98%5Cn%20%20%20%20%20%20%20%20Backend-%3E%3ELLM%3A%20%E5%8F%91%E9%80%81%E6%9C%80%E7%BB%88%E7%94%9F%E6%88%90%E8%AF%B7%E6%B1%82%5Cn%20%20%20%20%20%20%20%20LLM--%3E%3EBackend%3A%20%E6%B5%81%E5%BC%8F%E8%BF%94%E5%9B%9E%E7%AD%94%E6%A1%88%5Cn%20%20%20%20end%5Cn%20%20%20%20%5Cn%20%20%20%20Backend--%3E%3EFrontend%3A%20%E6%B5%81%E5%BC%8F%E8%BF%94%E5%9B%9E(context%20%2B%20answer)%5Cn%20%20%20%20%5Cn%20%20%20%20rect%20rgb(220%2C%20220%2C%20250)%5Cn%20%20%20%20%20%20%20%20Note%20over%20Frontend%3A%20%E5%93%8D%E5%BA%94%E5%A4%84%E7%90%86%E9%98%B6%E6%AE%B5%5Cn%20%20%20%20%20%20%20%20Frontend-%3E%3EFrontend%3A%20%E8%A7%A3%E6%9E%90context(base64)%5Cn%20%20%20%20%20%20%20%20Frontend-%3E%3EFrontend%3A%20%E8%A7%A3%E6%9E%90%E5%BC%95%E7%94%A8%E6%A0%87%E8%AE%B0%5Cn%20%20%20%20%20%20%20%20Frontend-%3E%3EFrontend%3A%20%E6%B8%B2%E6%9F%93%E5%9B%9E%E7%AD%94%E5%92%8C%E5%BC%95%E7%94%A8%5Cn%20%20%20%20end%5Cn%20%20%20%20%5Cn%20%20%20%20Frontend--%3E%3EUser%3A%20%E5%B1%95%E7%A4%BA%E7%AD%94%E6%A1%88%E5%92%8C%E5%BC%95%E7%94%A8%22%2C%22url%22%3Anull%2C%22id%22%3A%22lmVsK%22%7D"></card><ol list="uead4a57d"><li fid="u04cf59c0" data-lake-id="ue32abeba" id="ue32abeba"><strong><span data-lake-id="u782cf97e" id="u782cf97e">消息存储</span></strong></li></ol><ul list="u0bdff294" data-lake-indent="1"><li fid="u108273e3" data-lake-id="u403d5a7c" id="u403d5a7c"><span data-lake-id="ueadd773a" id="ueadd773a">将用户的提问内容保存为 user 类型的消息记录</span></li></ul><ul list="u5ed94a32" start="2" data-lake-indent="1"><li fid="uc5b69c7a" data-lake-id="uaa3e662f" id="uaa3e662f"><span data-lake-id="u93d9599b" id="u93d9599b">创建一个空的 assistant 类型消息记录作为占位符</span></li></ul><ol list="u4ca370fd" start="2"><li fid="udb9af523" data-lake-id="udb1d815f" id="udb1d815f"><strong><span data-lake-id="uaf98a1d5" id="uaf98a1d5">知识库准备</span></strong></li></ol><ul list="u6b5de2c6" data-lake-indent="1"><li fid="ue3e3f9dc" data-lake-id="u7c6e98e6" id="u7c6e98e6"><span data-lake-id="uc26e3419" id="uc26e3419">根据传入的 knowledge_base_ids 获取相关知识库</span></li></ul><ul list="u0858ba59" start="2" data-lake-indent="1"><li fid="u8e853f90" data-lake-id="ubbecda79" id="ubbecda79"><span data-lake-id="uf1e25753" id="uf1e25753">初始化 OpenAI Embeddings</span></li></ul><ul list="u4af24642" start="3" data-lake-indent="1"><li fid="uea574c85" data-lake-id="ua94c9f1a" id="ua94c9f1a"><span data-lake-id="u410719c8" id="u410719c8">为每个知识库创建对应的向量存储 (Vector Store)</span></li></ul><ol list="u7e42666d" start="3"><li fid="u7e7c83df" data-lake-id="ubf227846" id="ubf227846"><strong><span data-lake-id="uc790299d" id="uc790299d">检索增强生成 (RAG) 处理</span></strong></li></ol><ul list="u157b2c8e" data-lake-indent="1"><li fid="u3857f0ee" data-lake-id="u02c29931" id="u02c29931"><span data-lake-id="ue7757d64" id="ue7757d64">使用向量存储创建检索器 (Retriever)</span></li></ul><ul list="ucdd916c4" start="2" data-lake-indent="1"><li fid="u9eda3191" data-lake-id="ue47b173c" id="ue47b173c"><span data-lake-id="ueb9820bb" id="ueb9820bb">构建两个关键提示词模板:</span></li></ul><ul list="u200d6e8f" data-lake-indent="2"><li fid="ud72b892c" data-lake-id="ub84a33a1" id="ub84a33a1"><code data-lake-id="ue26f7dc5" id="ue26f7dc5"><span data-lake-id="uc93eda00" id="uc93eda00">contextualize_q_prompt</span></code><span data-lake-id="ue1db17ef" id="ue1db17ef">: 用于理解聊天历史上下文,重新构造独立的问题</span></li></ul><ul list="uecb2087e" start="2" data-lake-indent="2"><li fid="u951a2b77" data-lake-id="u53fde10c" id="u53fde10c"><code data-lake-id="ufafd8053" id="ufafd8053"><span data-lake-id="u1cfbe01a" id="u1cfbe01a">qa_prompt</span></code><span data-lake-id="u3178898a" id="u3178898a">: 用于生成最终答案,包含引用格式要求和语言适配等规则</span></li></ul><ol list="u77fa7d68" start="4"><li fid="u63758292" data-lake-id="u6cebb42b" id="u6cebb42b"><strong><span data-lake-id="ud1f86585" id="ud1f86585">响应生成</span></strong></li></ol><ul list="u1473dcae" data-lake-indent="1"><li fid="u13bc82aa" data-lake-id="u775a7a7a" id="u775a7a7a"><span data-lake-id="u2e345767" id="u2e345767">处理历史聊天记录,构建对话上下文</span></li></ul><ul list="u8c2c6a2e" start="2" data-lake-indent="1"><li fid="u81689bbd" data-lake-id="ufd333f98" id="ufd333f98"><span data-lake-id="uef9f3335" id="uef9f3335">使用流式响应逐步生成内容</span></li></ul><ul list="u4197d8f8" start="3" data-lake-indent="1"><li fid="u76d9248f" data-lake-id="ub96eab5c" id="ub96eab5c"><span data-lake-id="u0c1a7ed8" id="u0c1a7ed8">响应内容包含两部分:</span></li></ul><ul list="u3f8d29dd" data-lake-indent="2"><li fid="u4e7ee4c1" data-lake-id="ud2156fc2" id="ud2156fc2"><span data-lake-id="u1259b7be" id="u1259b7be">相关文档上下文 (base64 编码)</span></li></ul><ul list="ud54a680e" start="2" data-lake-indent="2"><li fid="uad59d401" data-lake-id="u6d92f37a" id="u6d92f37a"><span data-lake-id="ua555939e" id="ua555939e">LLM 生成的回答内容</span></li></ul><ol list="u0c168626" start="5"><li fid="u4e1af11c" data-lake-id="u3a1a61c0" id="u3a1a61c0"><strong><span data-lake-id="uec7bb04c" id="uec7bb04c">结果处理</span></strong></li></ol><ul list="u8d8ce0db" data-lake-indent="1"><li fid="u04f34ed8" data-lake-id="u91e36dae" id="u91e36dae"><span data-lake-id="u10e4f0a0" id="u10e4f0a0">实时返回生成的内容片段</span></li></ul><ul list="u54ed808f" start="2" data-lake-indent="1"><li fid="u0fa163eb" data-lake-id="u155d85d8" id="u155d85d8"><span data-lake-id="u4585e891" id="u4585e891">更新数据库中的 assistant 消息记录</span></li></ul><ul list="u0dc085fd" start="3" data-lake-indent="1"><li fid="u4104cfd0" data-lake-id="ub18b1f58" id="ub18b1f58"><span data-lake-id="u31497efa" id="u31497efa">完整响应格式: </span><code data-lake-id="u55fd7bed" id="u55fd7bed"><span data-lake-id="u9ac58ac4" id="u9ac58ac4">{context_base64}__LLM_RESPONSE__{answer}</span></code></li></ul><ol list="u69f846ba" start="6"><li fid="u0468646f" data-lake-id="u112f26ab" id="u112f26ab"><strong><span data-lake-id="uf07a7ee9" id="uf07a7ee9">异常处理</span></strong></li></ol><ul list="u1af80f3d" data-lake-indent="1"><li fid="u9d9cb728" data-lake-id="ue6ac30e2" id="ue6ac30e2"><span data-lake-id="u285b1f0d" id="u285b1f0d">捕获并记录生成过程中的错误</span></li></ul><ul list="ua68c2bda" start="2" data-lake-indent="1"><li fid="u21e9af56" data-lake-id="udf788db9" id="udf788db9"><span data-lake-id="uc5789cd4" id="uc5789cd4">更新错误信息到消息记录</span></li></ul><ul list="u93f9bece" start="3" data-lake-indent="1"><li fid="u8b1a0542" data-lake-id="u55185e1d" id="u55185e1d"><span data-lake-id="ub9351caa" id="ub9351caa">确保数据库会话正确关闭</span></li></ul><p data-lake-id="u9eee59f5" id="u9eee59f5"><span data-lake-id="u3e84b3f9" id="u3e84b3f9">前端接收到后台返回的 stream 返回以后，可开始解析这个 stream 后， 除了正常和其他 QA 聊天工具一样， 这里还多了一个引用信息， 所以需要解析出引用信息， 然后展示在页面上。</span></p><p data-lake-id="uc6e0319f" id="uc6e0319f"><span data-lake-id="u64365f9c" id="u64365f9c">他是怎么运作的呢？这里前端会通过 </span><code data-lake-id="u9f672fd2" id="u9f672fd2"><span data-lake-id="u21017be9" id="u21017be9">__LLM_RESPONSE__</span></code><span data-lake-id="u6c752f42" id="u6c752f42"> 这个分隔符来解析, 前面一部分是 RAG 检索出来的 context 信息（base64 编码， 可以理解为是检索出来的切片的数组），后面是 LLM 按照 context 回来的信息， 然后通过 </span><code data-lake-id="u7597eeb7" id="u7597eeb7"><span data-lake-id="u141bd0b3" id="u141bd0b3">[[citation:1]]</span></code><span data-lake-id="uda9f6b6a" id="uda9f6b6a"> 这个格式来解析出引用信息。</span></p><card type="block" name="diagram" value="data:%7B%22type%22%3A%22mermaid%22%2C%22code%22%3A%22flowchart%20TD%5Cn%20%20%20%20A%5B%E6%8E%A5%E6%94%B6Stream%E5%93%8D%E5%BA%94%5D%20--%3E%20B%7B%E8%A7%A3%E6%9E%90%E5%93%8D%E5%BA%94%7D%5Cn%20%20%20%20B%20--%3E%7C%E5%88%86%E5%89%B2%7C%20C%5BContext%E9%83%A8%E5%88%86%5D%5Cn%20%20%20%20B%20--%3E%7C%E5%88%86%E5%89%B2%7C%20D%5BAnswer%E9%83%A8%E5%88%86%5D%5Cn%20%20%20%20%5Cn%20%20%20%20C%20--%3E%20E%5BBase64%E8%A7%A3%E7%A0%81%5D%5Cn%20%20%20%20E%20--%3E%20F%5B%E8%A7%A3%E6%9E%90%E5%BC%95%E7%94%A8%E4%BF%A1%E6%81%AF%5D%5Cn%20%20%20%20%5Cn%20%20%20%20D%20--%3E%20G%5B%E8%A7%A3%E6%9E%90%E5%BC%95%E7%94%A8%E6%A0%87%E8%AE%B0%5D%5Cn%20%20%20%20G%20--%3E%20H%5B%5Bcitation%3A1%5D%5D%5Cn%20%20%20%20%5Cn%20%20%20%20F%20--%3E%20I%5B%E5%87%86%E5%A4%87%E5%BC%95%E7%94%A8%E6%95%B0%E6%8D%AE%5D%5Cn%20%20%20%20H%20--%3E%20I%5Cn%20%20%20%20%5Cn%20%20%20%20I%20--%3E%20J%5B%E6%B8%B2%E6%9F%93%E5%9B%9E%E7%AD%94%E5%86%85%E5%AE%B9%5D%5Cn%20%20%20%20J%20--%3E%20K%5B%E6%98%BE%E7%A4%BA%E5%BC%95%E7%94%A8%E5%BC%B9%E7%AA%97%5D%22%2C%22url%22%3Anull%2C%22id%22%3A%22rP5Ws%22%7D"></card><p data-lake-id="ua630f722" id="ua630f722"><span data-lake-id="u3123c6ba" id="u3123c6ba">代码可查询：</span></p><ul list="ub6de6260"><li fid="u24a1c62f" data-lake-id="u3b57945e" id="u3b57945e"><span data-lake-id="u9b6cd831" id="u9b6cd831">Chat 页面：</span><code data-lake-id="u4ebc4a2b" id="u4ebc4a2b"><span data-lake-id="ue79456c3" id="ue79456c3">frontend/src/app/dashboard/chat/[id]/page.tsx</span></code></li></ul><ul list="ue60da8b2" start="2"><li fid="ue5bdf790" data-lake-id="ub00fce36" id="ub00fce36"><span data-lake-id="ueba463fc" id="ueba463fc">引用信息展示：</span><code data-lake-id="u418f9773" id="u418f9773"><span data-lake-id="uc280a7aa" id="uc280a7aa">frontend/src/components/chat/answer.tsx</span></code></li></ul><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22javascript%22%2C%22code%22%3A%22%20%20const%20CitationLink%20%3D%20useMemo(%5Cn%20%20%20%20()%20%3D%3E%5Cn%20%20%20%20%20%20(%5Cn%20%20%20%20%20%20%20%20props%3A%20ClassAttributes%3CHTMLAnchorElement%3E%20%26%5Cn%20%20%20%20%20%20%20%20%20%20AnchorHTMLAttributes%3CHTMLAnchorElement%3E%5Cn%20%20%20%20%20%20)%20%3D%3E%20%7B%5Cn%20%20%20%20%20%20%20%20const%20citationId%20%3D%20props.href%3F.match(%2F%5E(%5C%5Cd%2B)%24%2F)%3F.%5B1%5D%3B%5Cn%20%20%20%20%20%20%20%20const%20citation%20%3D%20citationId%5Cn%20%20%20%20%20%20%20%20%20%20%3F%20citations%5BparseInt(citationId)%20-%201%5D%5Cn%20%20%20%20%20%20%20%20%20%20%3A%20null%3B%5Cn%5Cn%20%20%20%20%20%20%20%20if%20(!citation)%20%7B%5Cn%20%20%20%20%20%20%20%20%20%20return%20%3Ca%3E%5B%7Bprops.href%7D%5D%3C%2Fa%3E%3B%5Cn%20%20%20%20%20%20%20%20%7D%5Cn%5Cn%20%20%20%20%20%20%20%20const%20citationInfo%20%3D%5Cn%20%20%20%20%20%20%20%20%20%20citationInfoMap%5B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%60%24%7Bcitation.metadata.kb_id%7D-%24%7Bcitation.metadata.document_id%7D%60%5Cn%20%20%20%20%20%20%20%20%20%20%5D%3B%5Cn%5Cn%20%20%20%20%20%20%20%20return%20(%5Cn%20%20%20%20%20%20%20%20%20%20%3CPopover%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CPopoverTrigger%20asChild%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ca%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B...props%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20href%3D%5C%22%23%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20role%3D%5C%22button%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20className%3D%5C%22inline-flex%20items-center%20gap-1%20px-1.5%20py-0.5%20text-xs%20font-medium%20text-blue-600%20bg-blue-50%20rounded%20hover%3Abg-blue-100%20transition-colors%20relative%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cspan%20className%3D%5C%22absolute%20-top-3%20-right-1%5C%22%3E%5B%7Bprops.href%7D%5D%3C%2Fspan%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fa%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FPopoverTrigger%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3CPopoverContent%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20side%3D%5C%22top%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20align%3D%5C%22start%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20className%3D%5C%22max-w-2xl%20w-%5Bcalc(100vw-100px)%5D%20p-4%20rounded-lg%20shadow-lg%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22text-sm%20space-y-3%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7BcitationInfo%20%26%26%20(%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22flex%20items-center%20gap-2%20text-xs%20font-medium%20text-gray-700%20bg-gray-50%20p-2%20rounded%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22w-5%20h-5%20flex%20items-center%20justify-center%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CFileIcon%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20extension%3D%7B%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20citationInfo.document.file_name.split(%5C%22.%5C%22).pop()%20%7C%7C%20%5C%22%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color%3D%5C%22%23E2E8F0%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20labelColor%3D%5C%22%2394A3B8%5C%22%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cspan%20className%3D%5C%22truncate%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7BcitationInfo.knowledge_base.name%7D%20%2F%7B%5C%22%20%5C%22%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7BcitationInfo.document.file_name%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fspan%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDivider%20%2F%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cp%20className%3D%5C%22text-gray-700%20leading-relaxed%5C%22%3E%7Bcitation.text%7D%3C%2Fp%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3CDivider%20%2F%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7BObject.keys(citation.metadata).length%20%3E%200%20%26%26%20(%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22text-xs%20text-gray-500%20bg-gray-50%20p-2%20rounded%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22font-medium%20mb-2%5C%22%3EDebug%20Info%3A%3C%2Fdiv%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22space-y-1%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7BObject.entries(citation.metadata).map((%5Bkey%2C%20value%5D)%20%3D%3E%20(%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cdiv%20key%3D%7Bkey%7D%20className%3D%5C%22flex%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cspan%20className%3D%5C%22font-medium%20min-w-%5B100px%5D%5C%22%3E%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Bkey%7D%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fspan%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Cspan%20className%3D%5C%22text-gray-600%5C%22%3E%7BString(value)%7D%3C%2Fspan%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20))%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%7D%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%3C%2FPopoverContent%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%3C%2FPopover%3E%5Cn%5Cn%20%20%20%20%20%20%20%20)%3B%5Cn%20%20%20%20%20%20%7D%2C%5Cn%20%20%20%20%5Bcitations%2C%20citationInfoMap%5D%5Cn%20%20)%3B%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22nWyPb%22%7D"></card><p data-lake-id="u2b0e1013" id="u2b0e1013"><span data-lake-id="u5d79ed2d" id="u5d79ed2d">当用户点击引用信息的时候， 会弹出一个弹窗， 展示引用详情， 包括知识库名称， 文件名称， 以及引用内容。</span></p><h2 data-lake-id="FLvt9" id="FLvt9"><span data-lake-id="uc4fe8685" id="uc4fe8685">6. 拓展：根据需求定制你的 RAG</span></h2><h3 data-lake-id="Qxa7G" id="Qxa7G"><span data-lake-id="ua93edef7" id="ua93edef7">6.1 不同的向量数据库或大语言模型</span></h3><p data-lake-id="u329bc9a4" id="u329bc9a4"><span data-lake-id="ufd695cc3" id="ufd695cc3">目前已经通过 Factory 模式， 支持了不同的向量数据库、不同的大模型，例如 Ollama 也有同学在支持， 可以参考 </span><code data-lake-id="uaa7762c7" id="uaa7762c7"><span data-lake-id="u05900978" id="u05900978">backend/app/services/vector_store/factory.py</span></code><span data-lake-id="u388ed314" id="u388ed314"> 这个文件。</span></p><h3 data-lake-id="z3Drf" id="z3Drf"><span data-lake-id="ufa9fa0bc" id="ufa9fa0bc">6.2 Chunk 分割策略与 Embedding 模型的调整</span></h3><p data-lake-id="uab29a884" id="uab29a884"><span data-lake-id="u25992a30" id="u25992a30">不同的 Embedding 模型对多语言支持和文本类型有不同的特点：</span></p><ul list="u2b2bacde"><li fid="ud9101764" data-lake-id="ua4f97195" id="ua4f97195"><strong><span data-lake-id="ua2f47ded" id="ua2f47ded">多语言支持</span></strong><span data-lake-id="u9072046e" id="u9072046e">：</span></li></ul><ul list="u526ed098" data-lake-indent="1"><li fid="ua082eef8" data-lake-id="u382a9b47" id="u382a9b47"><code data-lake-id="uf6e7be07" id="uf6e7be07"><span data-lake-id="u1b1a9d10" id="u1b1a9d10">text-embedding-ada-002</span></code><span data-lake-id="ud5c59d6c" id="ud5c59d6c">：支持多种语言，但对中文等亚洲语言的支持相对较弱</span></li></ul><ul list="u0613c49c" start="2" data-lake-indent="1"><li fid="ud3d39929" data-lake-id="ub8806ae1" id="ub8806ae1"><code data-lake-id="u5064bba6" id="u5064bba6"><span data-lake-id="u769ff731" id="u769ff731">bge-large-zh</span></code><span data-lake-id="u9291af94" id="u9291af94">：对中文有很好的支持</span></li></ul><ul list="u29582670" start="3" data-lake-indent="1"><li fid="u6a9edbd0" data-lake-id="u798d22ef" id="u798d22ef"><code data-lake-id="ue9d94e3a" id="ue9d94e3a"><span data-lake-id="uf10a398f" id="uf10a398f">multilingual-e5-large</span></code><span data-lake-id="u069fdf68" id="u069fdf68">：对多语言都有较好的支持</span></li></ul><ul list="ud2d7d5fd" start="2"><li fid="ufc0529a5" data-lake-id="u5a05b431" id="u5a05b431"><strong><span data-lake-id="u3c8bfe8a" id="u3c8bfe8a">文本类型适用性</span></strong><span data-lake-id="ub6244b54" id="ub6244b54">：</span></li></ul><ul list="ua67873f0" data-lake-indent="1"><li fid="ucfe40e53" data-lake-id="u996b9efe" id="u996b9efe"><span data-lake-id="ue7d13b5a" id="ue7d13b5a">代码文本：建议使用专门的代码 Embedding 模型，如 </span><code data-lake-id="u42531a9f" id="u42531a9f"><span data-lake-id="u5fb0c447" id="u5fb0c447">CodeBERT</span></code></li></ul><ul list="u6a262275" start="2" data-lake-indent="1"><li fid="ub19bd8b3" data-lake-id="u1d7cce85" id="u1d7cce85"><span data-lake-id="u2961c248" id="u2961c248">通用文本：可以使用 </span><code data-lake-id="uf625f076" id="uf625f076"><span data-lake-id="u49ab6aad" id="u49ab6aad">text-embedding-ada-002</span></code><span data-lake-id="u75eb4f19" id="u75eb4f19"> 或 </span><code data-lake-id="ua2293f9b" id="ua2293f9b"><span data-lake-id="udd15ecf4" id="udd15ecf4">bge-large-zh</span></code></li></ul><ul list="u8bbd6afa" start="3" data-lake-indent="1"><li fid="u64a7145d" data-lake-id="ud6bc225c" id="ud6bc225c"><span data-lake-id="u7939e14b" id="u7939e14b">专业领域文本：建议使用该领域的专门模型</span></li></ul><p data-lake-id="ucde7eb7d" id="ucde7eb7d"><span data-lake-id="ub7046ae1" id="ub7046ae1">选择合适的 Embedding 模型可以显著提升检索效果。</span></p><h2 data-lake-id="XWdI4" id="XWdI4"><span data-lake-id="ub93fe29c" id="ub93fe29c">7. 总结与下一步</span></h2><p data-lake-id="u27a06647" id="u27a06647"><span data-lake-id="udd53c0b4" id="udd53c0b4">整个项目到这里就结束了， 整个项目中， 我们通过一个完整的工程实现示例， 来理解 RAG 在知识库问答中的具体应用流程。</span></p><p data-lake-id="u1450e437" id="u1450e437"><span data-lake-id="u123381a4" id="u123381a4">如果你需要 Ask Me Anything， 可以通过 </span><a href="https://github.com/rag-web-ui/rag-web-ui/issues" target="_blank" data-lake-id="ue6dd0ee8" id="ue6dd0ee8"><span data-lake-id="u9ff67145" id="u9ff67145">Issue</span></a><span data-lake-id="ub8738cc4" id="ub8738cc4"> 来联系我。</span></p><p data-lake-id="u6d3ac5a0" id="u6d3ac5a0"><span data-lake-id="ue8cb8bf6" id="ue8cb8bf6">你可以深入研究的方向</span></p><ul list="uc4fe5ba8"><li fid="ue2055498" data-lake-id="ufc8b3535" id="ufc8b3535"><span data-lake-id="u87cd5041" id="u87cd5041">多路召回（多个数据库或不同关注点检索结果的合并）</span></li></ul><ul list="u9c07f8e9" start="2"><li fid="uda914022" data-lake-id="u6b36d16b" id="u6b36d16b"><span data-lake-id="ud9688227" id="ud9688227">RAG + 交叉编码 re-ranking 提高回答精度</span></li></ul><ul list="u64649ab5" start="3"><li fid="uafc923b6" data-lake-id="u3a7930ce" id="u3a7930ce"><span data-lake-id="u4b919d4a" id="u4b919d4a">长文本多轮对话（上下文记忆 / Conversation Memory）</span></li></ul><ul list="u90231dea" start="4"><li fid="uf9a7e718" data-lake-id="u1e11ca92" id="u1e11ca92"><a href="https://python.langchain.com/" target="_blank" data-lake-id="ube2b26aa" id="ube2b26aa"><span data-lake-id="u0f0910ab" id="u0f0910ab">LangChain 官网</span></a><span data-lake-id="ua38b5e51" id="ua38b5e51">  </span></li></ul><ul list="u7c33e51b" start="5"><li fid="ubc6c4404" data-lake-id="u527e6674" id="u527e6674"><a href="https://docs.trychroma.com/" target="_blank" data-lake-id="uc309a4c6" id="uc309a4c6"><span data-lake-id="u09e86e1c" id="u09e86e1c">ChromaDB</span></a><span data-lake-id="u672dd9aa" id="u672dd9aa">  </span></li></ul><ul list="u6b3e1a7d" start="6"><li fid="ub3aae863" data-lake-id="u28e31aa3" id="u28e31aa3"><a href="https://platform.openai.com/docs/guides/embeddings" target="_blank" data-lake-id="u78d35a89" id="u78d35a89"><span data-lake-id="u60867567" id="u60867567">OpenAI Embeddings 介绍</span></a></li></ul><h2 data-lake-id="qGywY" id="qGywY"><span data-lake-id="u01084842" id="u01084842">8. 处理网络错误和无法访问的服务器</span></h2><p data-lake-id="u9aa3d6b7" id="u9aa3d6b7"><span data-lake-id="u687f4681" id="u687f4681">在注册账户时，可能会遇到网络错误或服务器无法访问的问题。以下是一些处理这些问题的方法：</span></p><h3 data-lake-id="SgDq6" id="SgDq6"><span data-lake-id="u8e48a928" id="u8e48a928">8.1 更新依赖项</span></h3><p data-lake-id="ufd475314" id="ufd475314"><span data-lake-id="u2c2bccdd" id="u2c2bccdd">确保 </span><code data-lake-id="u1aa1c42d" id="u1aa1c42d"><span data-lake-id="u7a123455" id="u7a123455">backend/requirements.txt</span></code><span data-lake-id="ubbba60bf" id="ubbba60bf"> 文件中指定的依赖项版本是可用的。例如，将 </span><code data-lake-id="u70e2b552" id="u70e2b552"><span data-lake-id="uac5f0ef7" id="uac5f0ef7">langchain-deepseek</span></code><span data-lake-id="ub3a6941a" id="ub3a6941a"> 的版本更新为 </span><code data-lake-id="u1085983e" id="u1085983e"><span data-lake-id="u9fa0b417" id="u9fa0b417">==0.1.1</span></code><span data-lake-id="ucfffe2f8" id="ucfffe2f8">：</span></p><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22plain%22%2C%22code%22%3A%22langchain-deepseek%3D%3D0.1.1%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22XTJDs%22%7D"></card><h3 data-lake-id="DXNTi" id="DXNTi"><span data-lake-id="u651061d4" id="u651061d4">8.2 错误处理</span></h3><p data-lake-id="u4116bf95" id="u4116bf95"><span data-lake-id="u7198d001" id="u7198d001">在 </span><code data-lake-id="ue5a3c147" id="ue5a3c147"><span data-lake-id="ua2dea27b" id="ua2dea27b">backend/app/api/api_v1/auth.py</span></code><span data-lake-id="uc4b60384" id="uc4b60384"> 文件中添加错误处理，以捕获注册过程中可能出现的网络错误和无法访问的服务器问题：</span></p><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22python%22%2C%22code%22%3A%22from%20requests.exceptions%20import%20RequestException%5Cn%5Cn%40router.post(%5C%22%2Fregister%5C%22%2C%20response_model%3DUserResponse)%5Cndef%20register(*%2C%20db%3A%20Session%20%3D%20Depends(get_db)%2C%20user_in%3A%20UserCreate)%20-%3E%20Any%3A%5Cn%20%20%20%20%5C%22%5C%22%5C%22%5Cn%20%20%20%20Register%20a%20new%20user.%5Cn%20%20%20%20%5C%22%5C%22%5C%22%5Cn%20%20%20%20try%3A%5Cn%20%20%20%20%20%20%20%20%23%20Check%20if%20user%20with%20this%20email%20exists%5Cn%20%20%20%20%20%20%20%20user%20%3D%20db.query(User).filter(User.email%20%3D%3D%20user_in.email).first()%5Cn%20%20%20%20%20%20%20%20if%20user%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20raise%20HTTPException(%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20status_code%3D400%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20detail%3D%5C%22A%20user%20with%20this%20email%20already%20exists.%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20)%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%23%20Check%20if%20user%20with%20this%20username%20exists%5Cn%20%20%20%20%20%20%20%20user%20%3D%20db.query(User).filter(User.username%20%3D%3D%20user_in.username).first()%5Cn%20%20%20%20%20%20%20%20if%20user%3A%5Cn%20%20%20%20%20%20%20%20%20%20%20%20raise%20HTTPException(%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20status_code%3D400%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20detail%3D%5C%22A%20user%20with%20this%20username%20already%20exists.%5C%22%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20)%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20%23%20Create%20new%20user%5Cn%20%20%20%20%20%20%20%20user%20%3D%20User(%5Cn%20%20%20%20%20%20%20%20%20%20%20%20email%3Duser_in.email%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20username%3Duser_in.username%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20hashed_password%3Dsecurity.get_password_hash(user_in.password)%2C%5Cn%20%20%20%20%20%20%20%20)%5Cn%20%20%20%20%20%20%20%20db.add(user)%5Cn%20%20%20%20%20%20%20%20db.commit()%5Cn%20%20%20%20%20%20%20%20db.refresh(user)%5Cn%20%20%20%20%20%20%20%20return%20user%5Cn%20%20%20%20except%20RequestException%20as%20e%3A%5Cn%20%20%20%20%20%20%20%20raise%20HTTPException(%5Cn%20%20%20%20%20%20%20%20%20%20%20%20status_code%3D503%2C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20detail%3D%5C%22Network%20error%20or%20server%20is%20unreachable.%20Please%20try%20again%20later.%5C%22%2C%5Cn%20%20%20%20%20%20%20%20)%20from%20e%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22POGCh%22%7D"></card><h3 data-lake-id="IOBLi" id="IOBLi"><span data-lake-id="u11de5bf3" id="u11de5bf3">8.3 重试机制</span></h3><p data-lake-id="u80bfabfd" id="u80bfabfd"><span data-lake-id="u00477ace" id="u00477ace">在 </span><code data-lake-id="u14c30f0b" id="u14c30f0b"><span data-lake-id="u784b46bc" id="u784b46bc">backend/Dockerfile</span></code><span data-lake-id="u74deb505" id="u74deb505"> 和 </span><code data-lake-id="uf5eeb2ae" id="uf5eeb2ae"><span data-lake-id="u8a431ca4" id="u8a431ca4">docker-compose.yml</span></code><span data-lake-id="u6a2dcfc4" id="u6a2dcfc4"> 文件中添加重试机制，以处理构建过程中可能出现的网络错误：</span></p><h4 data-lake-id="zsqOE" id="zsqOE"><code data-lake-id="u5506a27f" id="u5506a27f"><span data-lake-id="u5097880e" id="u5097880e">backend/Dockerfile</span></code></h4><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22dockerfile%22%2C%22code%22%3A%22%23%20Install%20Python%20packages%20with%20retry%20mechanism%5CnRUN%20pip%20install%20--no-cache-dir%20-r%20requirements.txt%20%7C%7C%20%5C%5C%5Cn%20%20%20%20(echo%20%5C%22Retrying%20in%205%20seconds...%5C%22%20%26%26%20sleep%205%20%26%26%20pip%20install%20--no-cache-dir%20-r%20requirements.txt)%20%7C%7C%20%5C%5C%5Cn%20%20%20%20(echo%20%5C%22Retrying%20in%2010%20seconds...%5C%22%20%26%26%20sleep%2010%20%26%26%20pip%20install%20--no-cache-dir%20-r%20requirements.txt)%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22dHZrO%22%7D"></card><h4 data-lake-id="M3zbd" id="M3zbd"><code data-lake-id="u3c9dd4a0" id="u3c9dd4a0"><span data-lake-id="u056fca03" id="u056fca03">docker-compose.yml</span></code></h4><card type="inline" name="codeblock" value="data:%7B%22search%22%3A%22%22%2C%22mode%22%3A%22yaml%22%2C%22code%22%3A%22services%3A%5Cn%20%20backend%3A%5Cn%20%20%20%20build%3A%20.%2Fbackend%5Cn%20%20%20%20restart%3A%20on-failure%5Cn%20%20%20%20deploy%3A%5Cn%20%20%20%20%20%20restart_policy%3A%5Cn%20%20%20%20%20%20%20%20condition%3A%20on-failure%5Cn%20%20%20%20%20%20%20%20delay%3A%205s%5Cn%20%20%20%20%20%20%20%20max_attempts%3A%203%22%2C%22autoWrap%22%3Afalse%2C%22lineNumbers%22%3Atrue%2C%22heightLimit%22%3Atrue%2C%22collapsed%22%3Afalse%2C%22hideToolbar%22%3Atrue%2C%22name%22%3A%22%22%2C%22tabSize%22%3Anull%2C%22indentWithTab%22%3Afalse%2C%22lightLines%22%3A%5B%5D%2C%22foldLines%22%3A%5B%5D%2C%22theme%22%3A%22Github%20Light%22%2C%22id%22%3A%22PHQMc%22%7D"></card><p data-lake-id="u1f614a90" id="u1f614a90"><span data-lake-id="u54a1caa8" id="u54a1caa8">通过以上方法，尝试处理注册账户时可能遇到的网络错误和无法访问的服务器问题。</span></p>